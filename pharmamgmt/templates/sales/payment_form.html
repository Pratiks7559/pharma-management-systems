{% extends 'base.html' %}
{% load custom_filters %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/payment_form3.css' %}">
{% endblock %}

{% block content %}
<div class="payment-form-container">
    <div class="payment-wrapper">
        <div class="payment-card">
            <div class="payment-header">
                <div class="header-content">
                    <h5 class="payment-title">
                        {% if is_edit %}
                            Edit Payment for Sales Invoice #{{ invoice.sales_invoice_no }}
                        {% else %}
                            Add Payment for Sales Invoice #{{ invoice.sales_invoice_no }}
                        {% endif %}
                    </h5>
                </div>
                <div class="payment-body">
                    <div class="invoice-summary-section">
                        <div class="invoice-details-card">
                            <h6 class="section-title">Invoice Details</h6>
                            <ul class="details-list">
                                <li class="detail-item"><strong class="detail-label">Invoice No:</strong> <span class="detail-value">{{ invoice.sales_invoice_no }}</span></li>
                                <li class="detail-item"><strong class="detail-label">Date:</strong> <span class="detail-value">{{ invoice.sales_invoice_date }}</span></li>
                                <li class="detail-item"><strong class="detail-label">Customer:</strong> <span class="detail-value">{{ invoice.customerid.customer_name }}</span></li>
                            </ul>
                        </div>
                        <div class="payment-details-card">
                            <h6 class="section-title">Payment Details</h6>
                            <ul class="details-list">
                                <li class="detail-item"><strong class="detail-label">Total Amount:</strong> <span class="detail-value amount-total">₹{{ invoice.sales_invoice_total|floatformat:2 }}</span></li>
                                <li class="detail-item"><strong class="detail-label">Amount Paid:</strong> <span class="detail-value amount-paid">₹{{ invoice.sales_invoice_paid|floatformat:2 }}</span></li>
                                <li class="detail-item"><strong class="detail-label">Balance Due:</strong> <span class="detail-value balance-due">₹{{ balance|floatformat:2 }}</span></li>
                            </ul>
                        </div>
                    </div>
                    
                    <form method="post" class="payment-form">
                        {% csrf_token %}
                        
                        <div class="form-section payment-info-section">
                            <div class="form-row">
                                <div class="form-group required">
                                    <label for="{{ form.sales_payment_date.id_for_label }}" class="field-label">Payment Date & Time</label>
                                    {{ form.sales_payment_date }}
                                    {% if form.sales_payment_date.errors %}
                                        <div class="error-message">{{ form.sales_payment_date.errors }}</div>
                                    {% endif %}
                                    <small class="form-text text-muted">Select the exact date and time of payment</small>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group required">
                                    <label for="{{ form.sales_payment_amount.id_for_label }}" class="field-label">Payment Amount</label>
                                    {{ form.sales_payment_amount }}
                                    {% if form.sales_payment_amount.errors %}
                                        <div class="error-message">{{ form.sales_payment_amount.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section payment-method-section">
                            <div class="form-row">
                                <div class="form-group required">
                                    <label for="{{ form.sales_payment_mode.id_for_label }}" class="field-label">Payment Mode</label>
                                    {{ form.sales_payment_mode }}
                                    {% if form.sales_payment_mode.errors %}
                                        <div class="error-message">{{ form.sales_payment_mode.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="{{ form.sales_payment_ref_no.id_for_label }}" class="field-label">Reference No.</label>
                                    {{ form.sales_payment_ref_no }}
                                    {% if form.sales_payment_ref_no.errors %}
                                        <div class="error-message">{{ form.sales_payment_ref_no.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary submit-btn">
                                <i class="fas fa-save"></i>
                                {% if is_edit %}
                                    Update Payment
                                {% else %}
                                    Add Payment
                                {% endif %}
                            </button>
                            <a href="{% url 'sales_invoice_detail' pk=invoice.sales_invoice_no %}" class="btn btn-secondary back-btn">
                                <i class="fas fa-arrow-left"></i>Back to Invoice
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const paymentAmountInput = document.getElementById('{{ form.sales_payment_amount.id_for_label }}');
        const paymentDateInput = document.getElementById('{{ form.sales_payment_date.id_for_label }}');
        const balanceDue = {{ balance }};
        
        {% if not is_edit %}
        // Only set default amount for new payments
        paymentAmountInput.value = balanceDue.toFixed(2);
        
        // Set current datetime if not already set
        if (paymentDateInput && !paymentDateInput.value) {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            paymentDateInput.value = `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
        }
        {% endif %}
        
        // Add validation to prevent payment amount from exceeding balance due
        paymentAmountInput.addEventListener('change', function() {
            const amount = parseFloat(this.value) || 0;
            {% if is_edit %}
            // For edit, we need to calculate the max allowed amount
            // Allow the original amount plus the remaining balance
            const originalAmount = {{ payment.sales_payment_amount }};
            const maxAmount = originalAmount + balanceDue;
            
            if (amount > maxAmount) {
                alert('Payment amount cannot exceed ' + maxAmount.toFixed(2));
                this.value = maxAmount.toFixed(2);
            }
            {% else %}
            // For new payments, just check against balance
            if (amount > balanceDue) {
                alert('Payment amount cannot exceed the remaining balance of ' + balanceDue.toFixed(2));
                this.value = balanceDue.toFixed(2);
            }
            {% endif %}
        });
    });
</script>
{% endblock %}







