{% extends 'base.html' %}
{% load custom_filters %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header Section -->
    <div class="dashboard-header">
        <h1 class="dashboard-title">Dashboard</h1>
        <p class="dashboard-subtitle">Welcome back! Here's what's happening with your pharmacy today.</p>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
        <!-- Products Card -->
        <div class="stat-card stat-card-blue">
            <div class="stat-card-content">
                <div class="stat-info">
                    <p class="stat-label">Total Products</p>
                    <p class="stat-value">{{ product_count }}</p>
                </div>
                <div class="stat-icon stat-icon-blue">
                    <i class="fas fa-pills"></i>
                </div>
            </div>
        </div>

        <!-- Suppliers Card -->
        <div class="stat-card stat-card-green">
            <div class="stat-card-content">
                <div class="stat-info">
                    <p class="stat-label">Suppliers</p>
                    <p class="stat-value">{{ supplier_count }}</p>
                </div>
                <div class="stat-icon stat-icon-green">
                    <i class="fas fa-truck"></i>
                </div>
            </div>
        </div>

        <!-- Customers Card -->
        <div class="stat-card stat-card-purple">
            <div class="stat-card-content">
                <div class="stat-info">
                    <p class="stat-label">Customers</p>
                    <p class="stat-value">{{ customer_count }}</p>
                </div>
                <div class="stat-icon stat-icon-purple">
                    <i class="fas fa-users"></i>
                </div>
            </div>
        </div>

        <!-- Low Stock Card -->
        <div class="stat-card stat-card-red">
            <div class="stat-card-content">
                <div class="stat-info">
                    <p class="stat-label">Low Stock Items</p>
                    <p class="stat-value stat-value-red">{{ low_stock_count }}</p>
                </div>
                <div class="stat-icon stat-icon-red">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="main-content-grid">
        <!-- Financial Overview -->
        <div class="content-card">
            <div class="card-header">
                <div class="card-icon card-icon-emerald">
                    <i class="fas fa-chart-line"></i>
                </div>
                <h2 class="card-title">Financial Overview</h2>
            </div>
            
            <div class="financial-grid">
                <div class="financial-item financial-item-emerald">
                    <p class="financial-label">Monthly Sales</p>
                    <p class="financial-value">{{ monthly_sales|currency }}</p>
                </div>
                <div class="financial-item financial-item-blue">
                    <p class="financial-label">Monthly Purchases</p>
                    <p class="financial-value">{{ monthly_purchases|currency }}</p>
                </div>
                <div class="financial-item financial-item-amber">
                    <p class="financial-label">Total Receivable</p>
                    <p class="financial-value">{{ total_receivable|currency }}</p>
                </div>
                <div class="financial-item financial-item-rose">
                    <p class="financial-label">Total Payable</p>
                    <p class="financial-value">{{ total_payable|currency }}</p>
                </div>
            </div>
            
            <a href="{% url 'financial_report' %}" class="card-button card-button-emerald">
                <i class="fas fa-chart-bar"></i>
                View Full Report
            </a>
        </div>

        <!-- Inventory Status -->
        <div class="content-card">
            <div class="card-header">
                <div class="card-icon card-icon-orange">
                    <i class="fas fa-boxes"></i>
                </div>
                <h2 class="card-title">Inventory Status</h2>
            </div>
            
            <div class="alert-container">
                <div class="alert-box alert-red">
                    <div class="alert-content">
                        <i class="fas fa-exclamation-circle"></i>
                        <span>
                            <strong>{{ low_stock_products|length }}</strong> products are running low on stock
                        </span>
                    </div>
                </div>
                
                <div class="alert-box alert-amber">
                    <div class="alert-content">
                        <i class="fas fa-clock"></i>
                        <span>
                            <strong>{{ expired_products|length|default:0 }}</strong> products are expired or expiring soon
                        </span>
                    </div>
                </div>
            </div>

            {% if low_stock_products or expired_products %}
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Batch</th>
                            <th>Stock</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in low_stock_products|slice:":3" %}
                        <tr>
                            <td class="text-gray-800">{{ item.product.product_name }}</td>
                            <td class="text-gray-600">-</td>
                            <td class="text-gray-600">{{ item.current_stock }}</td>
                            <td>
                                <span class="status-badge status-red">
                                    Low Stock
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                        {% for item in expired_products|slice:":3" %}
                        <tr>
                            <td class="text-gray-800">{{ item.product.product_name }}</td>
                            <td class="text-gray-600">{{ item.batch_no }}</td>
                            <td class="text-gray-600">{{ item.current_stock }}</td>
                            <td>
                                {% if item.days_to_expiry < 0 %}
                                    <span class="status-badge status-red">
                                        Expired
                                    </span>
                                {% else %}
                                    <span class="status-badge status-amber">
                                        {{ item.days_to_expiry }} days
                                    </span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert-box" style="background: #f0f9ff; border-color: #0ea5e9; color: #0369a1;">
                <div class="alert-content">
                    <i class="fas fa-info-circle"></i>
                    <span>No low stock or expiring products found. All inventory levels are healthy!</span>
                </div>
            </div>
            {% endif %}
            
            <div class="card-footer">
                <a href="{% url 'low_stock_update' %}" class="card-button" style="background: #ff9800; color: white; margin-right: 10px;">
                    <i class="fas fa-plus-circle"></i>
                    Update Low Stock
                </a>
                <a href="{% url 'inventory_list' %}" class="card-button card-button-orange">
                    <i class="fas fa-boxes"></i>
                    View Inventory
                </a>
            </div>
        </div>
    </div>

    <!-- Recent Transactions -->
    <div class="main-content-grid">
        <!-- Recent Sales -->
        <div class="content-card">
            <div class="card-header">
                <div class="card-icon card-icon-blue">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <h2 class="card-title">Recent Sales</h2>
            </div>
            
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>Invoice #</th>
                            <th>Date</th>
                            <th>Customer</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for sale in recent_sales %}
                        <tr>
                            <td>
                                <a href="{% url 'sales_invoice_detail' pk=sale.sales_invoice_no %}" class="table-link">
                                    {{ sale.sales_invoice_no }}
                                </a>
                            </td>
                            <td class="text-gray-600">{{ sale.sales_invoice_date }}</td>
                            <td class="text-gray-800">{{ sale.customerid.customer_name }}</td>
                            <td class="font-semibold text-emerald-600">{{ sale.sales_invoice_total|currency }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center text-gray-500" style="padding: 32px;">No recent sales</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="card-footer">
                <a href="{% url 'sales_invoice_list' %}" class="card-button card-button-blue">
                    <i class="fas fa-list"></i>
                    View All Sales
                </a>
            </div>
        </div>

        <!-- Recent Purchases -->
        <div class="content-card">
            <div class="card-header">
                <div class="card-icon card-icon-purple">
                    <i class="fas fa-truck"></i>
                </div>
                <h2 class="card-title">Recent Purchases</h2>
            </div>
            
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>Invoice #</th>
                            <th>Date</th>
                            <th>Supplier</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for purchase in recent_purchases %}
                        <tr>
                            <td>
                                <a href="{% url 'invoice_detail' pk=purchase.invoiceid %}" class="table-link">
                                    {{ purchase.invoice_no }}
                                </a>
                            </td>
                            <td class="text-gray-600">{{ purchase.invoice_date }}</td>
                            <td class="text-gray-800">{{ purchase.supplierid.supplier_name }}</td>
                            <td class="font-semibold text-emerald-600">{{ purchase.invoice_total|currency }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center text-gray-500" style="padding: 32px;">No recent purchases</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="card-footer">
                <a href="{% url 'invoice_list' %}" class="card-button card-button-purple">
                    <i class="fas fa-list"></i>
                    View All Purchases
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}