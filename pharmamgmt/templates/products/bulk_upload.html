{% extends 'base.html' %}
{% load static %}

{% block title %}Bulk Upload Products{% endblock %}

{% block extra_css %}
<style>
    .file-upload {
        position: relative;
        border: 2px dashed #ccc;
        border-radius: 8px;
        padding: 40px 20px;
        text-align: center;
        transition: all 0.3s;
        margin-bottom: 20px;
        background-color: #f8f9fa;
    }

    .file-upload:hover {
        border-color: #3498db;
    }

    .file-upload input[type="file"] {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
    }

    .file-info {
        display: none;
        margin-top: 20px;
        padding: 15px;
        background-color: #e8f7f0;
        border-radius: 8px;
        border-left: 4px solid #2ecc71;
    }

    .file-preview {
        max-height: 300px;
        overflow-y: auto;
        margin-top: 20px;
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
    }

    .preview-table {
        width: 100%;
    }

    .preview-table th {
        background-color: #f8f9fa;
        position: sticky;
        top: 0;
    }

    .template-download {
        margin-top: 30px;
        text-align: center;
    }

    .error-message {
        color: #e74c3c;
        margin-top: 10px;
    }

    .success-message {
        color: #2ecc71;
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="form-card">
            <h2 class="form-title">Bulk Upload Products</h2>
            
            <div class="mb-4">
                <p>Use this form to upload multiple products at once using a CSV file. The file should contain the following columns:</p>
                <ul>
                    <li>product_name - The name of the product</li>
                    <li>product_company - The company/manufacturer name</li>
                    <li>product_packing - The packing information (e.g., "10x10")</li>
                    <li>product_salt - The salt composition</li>
                    <li>product_category - The category of the product</li>
                    <li>product_hsn - HSN code</li>
                    <li>product_hsn_percent - HSN percentage</li>
                    <li>rate_A - Price for Type A customers</li>
                    <li>rate_B - Price for Type B customers</li>
                    <li>rate_C - Price for Type C customers</li>
                </ul>
            </div>

            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                
                <div class="file-upload">
                    <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-muted"></i>
                    <h4>Drag & Drop CSV File Here</h4>
                    <p>or</p>
                    <button type="button" class="btn btn-outline-primary">Browse Files</button>
                    <input type="file" name="csv_file" id="csv_file" accept=".csv">
                </div>
                
                <div class="file-info" id="fileInfo">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-file-csv fa-2x me-3 text-success"></i>
                        <div>
                            <h5 class="mb-1" id="fileName">filename.csv</h5>
                            <p class="mb-0 text-muted" id="fileSize">0 KB</p>
                        </div>
                    </div>
                </div>
                
                <div class="file-preview" id="filePreview" style="display: none;">
                    <h5 class="mb-3">File Preview</h5>
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped preview-table" id="previewTable">
                            <thead>
                                <tr>
                                    <th>Product Name</th>
                                    <th>Company</th>
                                    <th>Packing</th>
                                    <th>Salt</th>
                                    <th>Category</th>
                                    <th>HSN</th>
                                    <th>HSN %</th>
                                    <th>Rate A</th>
                                    <th>Rate B</th>
                                    <th>Rate C</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Preview data will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="mt-4">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-upload me-2"></i> Upload Products
                    </button>
                    <a href="{% url 'product_list' %}" class="btn btn-secondary ms-2">
                        <i class="fas fa-times me-2"></i> Cancel
                    </a>
                </div>
            </form>
            
            <div class="template-download">
                <p>Need a template to get started?</p>
                <a href="{% url 'download_product_template' %}" class="btn btn-outline-info">
                    <i class="fas fa-download me-2"></i> Download CSV Template
                </a>
            </div>
            
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show mt-4" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const fileInput = document.getElementById('csv_file');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const filePreview = document.getElementById('filePreview');
        const previewTable = document.getElementById('previewTable').getElementsByTagName('tbody')[0];
        
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Show file info
                fileName.textContent = file.name;
                fileSize.textContent = (file.size / 1024).toFixed(2) + ' KB';
                fileInfo.style.display = 'block';
                
                // Parse and preview CSV
                if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const csvData = event.target.result;
                        const rows = csvData.split('\n');
                        
                        // Clear previous preview
                        previewTable.innerHTML = '';
                        
                        // Add first 5 rows to preview (skip header)
                        for (let i = 1; i < Math.min(rows.length, 6); i++) {
                            if (rows[i].trim() === '') continue;
                            
                            const cells = rows[i].split(',');
                            const row = previewTable.insertRow();
                            
                            for (let j = 0; j < Math.min(cells.length, 10); j++) {
                                const cell = row.insertCell();
                                cell.textContent = cells[j].trim().replace(/"/g, '');
                            }
                        }
                        
                        filePreview.style.display = 'block';
                    };
                    reader.readAsText(file);
                }
            } else {
                fileInfo.style.display = 'none';
                filePreview.style.display = 'none';
            }
        });
    });
</script>
{% endblock %}