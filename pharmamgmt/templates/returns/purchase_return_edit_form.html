{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/purchase_return_form.css' %}">
<link rel="stylesheet" href="{% static 'css/combined_invoice_form.css' %}">
<link rel="stylesheet" href="{% static 'css/ci_unique_styles.css' %}">
{% endblock %}

{% block content %}
<div class="ci-main-container">
    <div class="ci-wrapper-card">
        <div class="ci-page-header">
            <h5 class="ci-main-title">
                <i class="fas fa-edit text-primary"></i> Edit Purchase Return
            </h5>
        </div>
        
        <div class="ci-content-body">
            <form method="post" id="editReturnForm" class="ci-main-form">
                {% csrf_token %}
                
                <!-- Return Invoice Details Section -->
                <div class="ci-invoice-details-section">
                    <h6 class="ci-section-title">Return Invoice Details</h6>
                    
                    <div class="return-id-preview">
                        <strong>Return ID:</strong> {{ return_invoice.returninvoiceid }}
                    </div>
                    
                    <div class="ci-form-row">
                        <div class="ci-form-column">
                            <div class="ci-supplier-field-group">
                                <label class="ci-supplier-label required">Supplier*</label>
                                <select name="returnsupplierid" class="form-control" required>
                                    {% for supplier in suppliers %}
                                    <option value="{{ supplier.supplierid }}" {% if supplier.supplierid == return_invoice.returnsupplierid.supplierid %}selected{% endif %}>
                                        {{ supplier.supplier_name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="ci-form-column">
                            <div class="ci-field-group">
                                <label class="ci-field-label required">Return Date*</label>
                                <input type="date" name="returninvoice_date" class="form-control" 
                                       value="{{ return_invoice.returninvoice_date|date:'Y-m-d' }}" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="ci-form-row">
                        <div class="ci-form-column">
                            <div class="ci-field-group">
                                <label class="ci-field-label">Return Charges</label>
                                <input type="number" name="return_charges" class="form-control" step="0.01" 
                                       value="{{ return_invoice.return_charges }}" oninput="calculateReturnTotal()">
                            </div>
                        </div>
                        <div class="ci-form-column">
                            <div class="ci-field-group">
                                <label class="ci-field-label required">Return Total*</label>
                                <input type="number" name="returninvoice_total" class="form-control" step="0.01" 
                                       value="{{ return_invoice.returninvoice_total }}" readonly>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Products Section -->
                <div class="ci-products-section">
                    <div class="ci-products-header">
                        <div class="ci-products-title-area">
                            <h6 class="ci-section-title">Return Products</h6>
                            <small class="ci-keyboard-shortcuts">F2: Search | Ctrl+Enter: Add | Ctrl+S: Save</small>
                        </div>
                        <button type="button" class="ci-add-product-btn" onclick="addReturnProductRow()">
                            <i class="fas fa-plus"></i> Add Product
                        </button>
                    </div>
                    <div class="ci-table-container">
                        <table class="ci-products-table" id="returnProductsTable">
                            <thead class="ci-table-header">
                                <tr class="ci-header-row">
                                    <th class="ci-th-product">Product</th>
                                    <th class="ci-th-batch">Batch No</th>
                                    <th class="ci-th-expiry">Expiry</th>
                                    <th class="ci-th-mrp">MRP</th>
                                    <th class="ci-th-purchase-rate">Return Rate</th>
                                    <th class="ci-th-qty">Return Qty</th>
                                    <th class="ci-th-discount">Scheme</th>
                                    <th class="ci-th-charges">Charges</th>
                                    <th class="ci-th-reason">Reason</th>
                                    <th class="ci-th-total">Total</th>
                                    <th class="ci-th-action">Action</th>
                                </tr>
                            </thead>
                            <tbody id="returnProductRows" class="ci-table-body">
                                <!-- Existing return items will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="ci-total-section">
                        <div class="ci-grand-total-display">
                            <strong class="ci-total-text">Return Total: â‚¹<span id="returnTotal" class="ci-total-amount">0.00</span></strong>
                        </div>
                    </div>
                </div>

                <!-- Hidden field for products data -->
                <input type="hidden" name="products_data" id="returnProductsData">

                <!-- Submit Button -->
                <div class="ci-form-actions">
                    <a href="{% url 'purchase_return_detail' return_invoice.returninvoiceid %}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancel
                    </a>
                    <button type="submit" class="ci-save-btn" id="saveReturnBtn">
                        <i class="fas fa-save"></i> Update Purchase Return
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let returnProductRowIndex = 0;
const existingProducts = {{ return_items|safe }};

// Load existing products on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load existing return items
    {% for item in return_items %}
    addReturnProductRow(
        {{ item.returnproductid.productid }},
        '{{ item.returnproduct_batch_no }}',
        '{{ item.returnproduct_expiry|date:"m-Y" }}',
        {{ item.returnproduct_MRP }},
        {{ item.returnproduct_purchase_rate }},
        {{ item.returnproduct_quantity }},
        {{ item.returnproduct_scheme }},
        {{ item.returnproduct_charges }},
        '{{ item.return_reason|default:"" }}'
    );
    {% endfor %}
    
    calculateReturnTotal();
    
    const form = document.getElementById('editReturnForm');
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const productsData = collectReturnProductsData();
        if (productsData.length === 0) {
            alert('Please add at least one product to the return.');
            return false;
        }
        
        document.getElementById('returnProductsData').value = JSON.stringify(productsData);
        
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
        }
        
        form.submit();
    });
});

function addReturnProductRow(productId = '', batchNo = '', expiry = '', mrp = '', returnRate = '', returnQty = '', scheme = '', charges = '', reason = '') {
    const tbody = document.getElementById('returnProductRows');
    const row = document.createElement('tr');
    row.id = `returnProductRow_${returnProductRowIndex}`;
    
    row.innerHTML = `
        <td><select class="product-select" onchange="loadReturnProductInfo(${returnProductRowIndex}, this.value)" required>
            <option value="">Select Product</option>
            {% for product in products %}
            <option value="{{ product.productid }}" ${productId == {{ product.productid }} ? 'selected' : ''}>{{ product.product_name }} - {{ product.product_company }}</option>
            {% endfor %}
        </select></td>
        <td><input type="text" class="batch-no" placeholder="Batch No" value="${batchNo}" required></td>
        <td><input type="text" class="expiry date-input" placeholder="MM-YYYY" maxlength="7" value="${expiry}" required></td>
        <td><input type="number" class="mrp" step="0.01" placeholder="MRP" min="0.01" value="${mrp}" required></td>
        <td><input type="number" class="return-rate" step="0.01" placeholder="Return Rate" min="0.01" value="${returnRate}" onchange="calculateReturnRowTotal(${returnProductRowIndex})" required></td>
        <td><input type="number" class="return-qty" placeholder="Return Qty" min="0.01" step="0.01" value="${returnQty}" onchange="calculateReturnRowTotal(${returnProductRowIndex})" required></td>
        <td><input type="number" class="scheme" step="0.01" placeholder="Scheme" min="0" value="${scheme}" onchange="calculateReturnRowTotal(${returnProductRowIndex})"></td>
        <td><input type="number" class="charges" step="0.01" placeholder="Charges" min="0" value="${charges}" onchange="calculateReturnRowTotal(${returnProductRowIndex})"></td>
        <td><input type="text" class="reason" placeholder="Return Reason" maxlength="200" value="${reason}"></td>
        <td><span class="return-row-total">0.00</span></td>
        <td><button type="button" class="remove-btn" onclick="removeReturnProductRow(${returnProductRowIndex})" title="Remove Row"><i class="fas fa-trash"></i></button></td>
    `;
    
    tbody.appendChild(row);
    calculateReturnRowTotal(returnProductRowIndex);
    returnProductRowIndex++;
}

function removeReturnProductRow(rowIndex) {
    const row = document.getElementById(`returnProductRow_${rowIndex}`);
    if (row) {
        row.remove();
        calculateReturnTotal();
    }
}

function calculateReturnRowTotal(rowIndex) {
    const row = document.getElementById(`returnProductRow_${rowIndex}`);
    if (!row) return;
    
    const rate = parseFloat(row.querySelector('.return-rate').value) || 0;
    const qty = parseFloat(row.querySelector('.return-qty').value) || 0;
    const scheme = parseFloat(row.querySelector('.scheme').value) || 0;
    const charges = parseFloat(row.querySelector('.charges').value) || 0;
    
    const subtotal = rate * qty;
    const afterScheme = subtotal - scheme;
    const total = afterScheme + charges;
    
    row.querySelector('.return-row-total').textContent = total.toFixed(2);
    calculateReturnTotal();
}

function calculateReturnTotal() {
    let total = 0;
    document.querySelectorAll('.return-row-total').forEach(span => {
        total += parseFloat(span.textContent) || 0;
    });
    
    const returnCharges = parseFloat(document.querySelector('input[name="return_charges"]')?.value) || 0;
    total += returnCharges;
    
    document.getElementById('returnTotal').textContent = total.toFixed(2);
    
    const returnTotalInput = document.querySelector('input[name="returninvoice_total"]');
    if (returnTotalInput) {
        returnTotalInput.value = total.toFixed(2);
    }
}

function loadReturnProductInfo(rowIndex, productId) {
    if (!productId) return;
    
    fetch(`/get-product-info/?product_id=${productId}`)
        .then(response => response.json())
        .then(data => {
            const row = document.getElementById(`returnProductRow_${rowIndex}`);
            if (row && !row.querySelector('.batch-no').value) {
                row.querySelector('.mrp').value = data.product_MRP || '';
                row.querySelector('.return-rate').value = data.last_purchase_rate || '';
                calculateReturnRowTotal(rowIndex);
            }
        });
}

function collectReturnProductsData() {
    const products = [];
    const rows = document.querySelectorAll('#returnProductRows tr');
    
    rows.forEach(row => {
        const productSelect = row.querySelector('.product-select');
        const productId = productSelect ? productSelect.value : '';
        
        if (productId) {
            products.push({
                productid: productId,
                batch_no: row.querySelector('.batch-no')?.value?.trim() || '',
                expiry: row.querySelector('.expiry')?.value?.trim() || '',
                mrp: row.querySelector('.mrp')?.value?.trim() || '0',
                return_rate: row.querySelector('.return-rate')?.value?.trim() || '0',
                return_quantity: row.querySelector('.return-qty')?.value?.trim() || '0',
                scheme: row.querySelector('.scheme')?.value?.trim() || '0',
                charges: row.querySelector('.charges')?.value?.trim() || '0',
                reason: row.querySelector('.reason')?.value?.trim() || ''
            });
        }
    });
    
    return products;
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        addReturnProductRow();
    }
    
    if (e.ctrlKey && e.key.toLowerCase() === 's') {
        e.preventDefault();
        document.getElementById('editReturnForm').dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
    }
    
    if (e.key === 'F2') {
        e.preventDefault();
        alert('Quick search feature - to be implemented');
    }
});
</script>

<style>
.ci-main-container {
    padding: 10px;
}

.ci-wrapper-card {
    margin: 0;
    padding: 15px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.ci-page-header {
    margin-bottom: 15px;
    padding: 10px 0;
    border-bottom: 2px solid #e5e7eb;
}

.ci-main-title {
    font-size: 1.1rem;
    margin: 0;
}

.ci-invoice-details-section {
    margin-bottom: 15px;
}

.ci-section-title {
    font-size: 1rem;
    margin-bottom: 10px;
    color: #374151;
}

.return-id-preview {
    background: #f0f9ff;
    padding: 8px 12px;
    border-radius: 4px;
    margin-bottom: 15px;
    font-size: 0.9rem;
    border-left: 4px solid #3b82f6;
}

.ci-form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 15px;
}

.ci-form-column {
    display: flex;
    flex-direction: column;
}

.ci-field-label,
.ci-supplier-label {
    font-size: 0.9rem;
    margin-bottom: 5px;
    font-weight: 500;
}

.required::after {
    content: ' *';
    color: #dc2626;
}

.form-control {
    padding: 8px 12px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    font-size: 0.9rem;
}

.form-control:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.ci-products-section {
    margin-top: 20px;
}

.ci-products-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.ci-keyboard-shortcuts {
    font-size: 0.75rem;
    color: #6b7280;
}

.ci-add-product-btn {
    background: #059669;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
}

.ci-add-product-btn:hover {
    background: #047857;
}

.ci-table-container {
    overflow-x: auto;
    margin-bottom: 15px;
}

.ci-products-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
}

.ci-products-table th {
    background: #f9fafb;
    padding: 8px;
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid #e5e7eb;
}

.ci-products-table td {
    padding: 6px 8px;
    border-bottom: 1px solid #e5e7eb;
}

.ci-products-table input,
.ci-products-table select {
    width: 100%;
    padding: 4px 6px;
    border: 1px solid #d1d5db;
    border-radius: 3px;
    font-size: 0.8rem;
}

.remove-btn {
    background: #dc2626;
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 3px;
    cursor: pointer;
}

.remove-btn:hover {
    background: #b91c1c;
}

.ci-total-section {
    text-align: right;
    padding: 10px;
    background: #f9fafb;
    border-radius: 4px;
}

.ci-total-amount {
    font-size: 1.2rem;
    color: #059669;
}

.ci-form-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 20px;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
}

.btn-secondary {
    background: #6b7280;
    color: white;
}

.btn-secondary:hover {
    background: #4b5563;
}

.ci-save-btn {
    background: #3b82f6;
    color: white;
}

.ci-save-btn:hover {
    background: #2563eb;
}
</style>
{% endblock %}
