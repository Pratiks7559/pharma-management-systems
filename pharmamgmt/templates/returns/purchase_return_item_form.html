{% extends 'base.html' %}
{% load custom_filters %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="{% static 'css/purchase_return_item_form.css' %}">
{% endblock %}

{% block content %}
<div class="purchase-return-item-form-container">
    <div class="purchase-return-item-form-header">
        <h4 class="purchase-return-item-form-title">
            <i class="fas fa-plus text-success"></i> Add Return Item
        </h4>
        <a href="{% url 'purchase_return_detail' pk=return_invoice.returninvoiceid %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to Return
        </a>
    </div>
    
    <div class="return-context-info">
        <div class="return-context-card">
            <div class="return-context-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="context-item">
                            <label>Return ID:</label>
                            <span class="return-id">{{ return_invoice.returninvoiceid }}</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="context-item">
                            <label>Supplier:</label>
                            <span>{{ return_invoice.returnsupplierid.supplier_name }}</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="context-item">
                            <label>Return Date:</label>
                            <span>{{ return_invoice.returninvoice_date|date:"d-m-Y" }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="purchase-return-item-form-card">
        <div class="purchase-return-item-form-body">
            <form method="post" class="purchase-return-item-form">
                {% csrf_token %}
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.returnproductid.id_for_label }}" class="form-label required">Product</label>
                            {{ form.returnproductid }}
                            {% if form.returnproductid.errors %}
                                <div class="invalid-feedback d-block">{{ form.returnproductid.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.returnproduct_batch_no.id_for_label }}" class="form-label required">Batch Number</label>
                            {{ form.returnproduct_batch_no }}
                            {% if form.returnproduct_batch_no.errors %}
                                <div class="invalid-feedback d-block">{{ form.returnproduct_batch_no.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="{{ form.returnproduct_expiry.id_for_label }}" class="form-label required">Expiry Date</label>
                            {{ form.returnproduct_expiry }}
                            {% if form.returnproduct_expiry.errors %}
                                <div class="invalid-feedback d-block">{{ form.returnproduct_expiry.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="{{ form.returnproduct_MRP.id_for_label }}" class="form-label required">MRP</label>
                            {{ form.returnproduct_MRP }}
                            {% if form.returnproduct_MRP.errors %}
                                <div class="invalid-feedback d-block">{{ form.returnproduct_MRP.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="{{ form.returnproduct_purchase_rate.id_for_label }}" class="form-label required">Purchase Rate</label>
                            {{ form.returnproduct_purchase_rate }}
                            {% if form.returnproduct_purchase_rate.errors %}
                                <div class="invalid-feedback d-block">{{ form.returnproduct_purchase_rate.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="{{ form.returnproduct_quantity.id_for_label }}" class="form-label required">Quantity</label>
                            {{ form.returnproduct_quantity }}
                            {% if form.returnproduct_quantity.errors %}
                                <div class="invalid-feedback d-block">{{ form.returnproduct_quantity.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="{{ form.returnproduct_scheme.id_for_label }}" class="form-label">Scheme</label>
                            {{ form.returnproduct_scheme }}
                            {% if form.returnproduct_scheme.errors %}
                                <div class="invalid-feedback d-block">{{ form.returnproduct_scheme.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="{{ form.returnproduct_charges.id_for_label }}" class="form-label">Additional Charges</label>
                            {{ form.returnproduct_charges }}
                            {% if form.returnproduct_charges.errors %}
                                <div class="invalid-feedback d-block">{{ form.returnproduct_charges.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="{{ form.return_reason.id_for_label }}" class="form-label">Return Reason</label>
                    {{ form.return_reason }}
                    <small class="form-text text-muted">Explain why this product is being returned</small>
                    {% if form.return_reason.errors %}
                        <div class="invalid-feedback d-block">{{ form.return_reason.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="calculation-preview">
                    <div class="calculation-card">
                        <h6><i class="fas fa-calculator text-info"></i> Calculation Preview</h6>
                        <div class="calculation-details">
                            <div class="calc-row">
                                <span>Rate × Quantity:</span>
                                <span id="subtotal">₹0.00</span>
                            </div>
                            <div class="calc-row">
                                <span>Additional Charges:</span>
                                <span id="charges">₹0.00</span>
                            </div>
                            <div class="calc-row total-calc">
                                <span><strong>Total Amount:</strong></span>
                                <span id="total"><strong>₹0.00</strong></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Add Return Item
                    </button>
                    <a href="{% url 'purchase_return_detail' pk=return_invoice.returninvoiceid %}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const rateField = document.getElementById('{{ form.returnproduct_purchase_rate.id_for_label }}');
    const quantityField = document.getElementById('{{ form.returnproduct_quantity.id_for_label }}');
    const chargesField = document.getElementById('{{ form.returnproduct_charges.id_for_label }}');
    
    function updateCalculation() {
        const rate = parseFloat(rateField.value) || 0;
        const quantity = parseFloat(quantityField.value) || 0;
        const charges = parseFloat(chargesField.value) || 0;
        
        const subtotal = rate * quantity;
        const total = subtotal + charges;
        
        document.getElementById('subtotal').textContent = '₹' + subtotal.toFixed(2);
        document.getElementById('charges').textContent = '₹' + charges.toFixed(2);
        document.getElementById('total').textContent = '₹' + total.toFixed(2);
    }
    
    rateField.addEventListener('input', updateCalculation);
    quantityField.addEventListener('input', updateCalculation);
    chargesField.addEventListener('input', updateCalculation);
    
    // Initial calculation
    updateCalculation();
});
</script>
{% endblock %}