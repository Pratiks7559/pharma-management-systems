{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

 {% block extra_css %}
<link rel="stylesheet" href="{% static 'css/sales_return_form.css' %}">
{% endblock %}

{% block content %}
<div class="sr-compact-container">
    <div class="sr-card">
        <div class="sr-header">
            <div class="sr-header-content">
                <h5 class="sr-title">{{ title }}</h5>
                {% if preview_id %}
                <small class="sr-return-number">Return ID: {{ preview_id }}</small>
                {% endif %}
            </div>
        </div>
        
        <div class="sr-body">
            <form method="post" id="salesReturnForm" class="sr-form">
                {% csrf_token %}
                
                <!-- Return Information Section -->
                <div class="sr-details-section">
                    <div class="sr-form-row">
                        <div class="sr-form-group required">
                            <label for="return_date" class="sr-field-label">Return Date</label>
                            <input type="date" name="return_sales_invoice_date" id="return_date" class="sr-form-input" 
                                   value="{{ form.return_sales_invoice_date.value|default:'' }}" 
                                   title="Enter return date" required>
                            <small class="sr-text-muted">📅 Current date auto-filled</small>
                        </div>
                        
                        <div class="sr-form-group required">
                            <label for="customerSelect" class="sr-field-label">Customer</label>
                            <select name="return_sales_customerid" id="customerSelect" class="sr-form-input" 
                                    onchange="loadCustomerRateType(this.value)" required>
                                <option value="">Select Customer</option>
                                {% for customer in customers %}
                                <option value="{{ customer.customerid }}" data-rate-type="{{ customer.customer_type }}">{{ customer.customer_name }}</option>
                                {% endfor %}
                            </select>
                            <div id="customerRateInfo" class="sr-customer-rate-info" style="display: none;">
                                <small class="sr-customer-rate-text"></small>
                            </div>
                        </div>
                        
                        <div class="sr-form-group">
                            <label for="additionalCharges" class="sr-field-label">Additional Charges</label>
                            <input type="number" name="return_sales_charges" id="additionalCharges" class="sr-form-input" 
                                   value="0" step="0.01" min="0">
                        </div>
                    </div>
                </div>
                
                <!-- Products Section -->
                <div class="sr-products-section">
                    <div class="sr-products-header">
                        <div class="sr-products-title-section">
                            <h6 class="sr-section-title">Return Products</h6>
                            <small class="sr-keyboard-shortcuts">⚡ F2 (Quick Search), Ctrl+Enter (Add Row), Alt+W (Batch Selector), Ctrl+S (Save)</small>
                        </div>
                        <button type="button" class="sr-add-product-btn" onclick="addProductRow()">
                            <i class="fas fa-plus"></i> Add Product
                        </button>
                    </div>
                    
                    <div class="sr-products-table-container">
                        <div class="sr-table-wrapper">
                            <table id="productsTable" class="sr-products-table">
                                <thead class="sr-table-header">
                                    <tr class="sr-header-row">
                                        <th class="product-col">Product</th>
                                        <th class="batch-col">Batch No</th>
                                        <th class="expiry-col">Expiry</th>
                                        <th class="mrp-col">MRP</th>
                                        <th class="rate-col">Rate</th>
                                        <th class="qty-col">Qty</th>
                                        <th class="discount-col">Discount</th>
                                        <th class="gst-col">GST%</th>
                                        <th class="total-col">Total</th>
                                        <th class="action-col">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="productsTableBody" class="sr-table-body">
                                    <!-- Product rows will be added here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="sr-total-section">
                            <div class="sr-total-wrapper">
                                <div class="sr-grand-total">
                                    <strong class="sr-total-label">Grand Total: ₹<span id="grandTotal" class="sr-total-amount">0.00</span></strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Hidden field for products data -->
                <input type="hidden" name="products_data" id="productsData">
                
                <!-- Submit Button -->
                <div class="sr-form-actions">
                    <button type="submit" class="sr-btn sr-btn-primary sr-save-btn">
                        <i class="fas fa-save"></i> Save Sales Return
                    </button>
                    <a href="{% url 'sales_return_list' %}" class="sr-btn sr-btn-secondary sr-back-btn">
                        <i class="fas fa-arrow-left"></i> Back to Returns
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let productRowCount = 0;
let products = [];
let selectedCustomerRateType = 'A'; // Default rate type

// Add product row
function addProductRow() {
    const tbody = document.getElementById('productsTableBody');
    const row = document.createElement('tr');
    row.id = `productRow_${productRowCount}`;
    
    row.innerHTML = `
        <td class="product-cell">
            <select class="product-select" onchange="loadProductDetails(this, ${productRowCount})" required>
                <option value="">Select Product</option>
                {% for product in products %}
                <option value="{{ product.productid }}">{{ product.product_name }} - {{ product.product_company }}</option>
                {% endfor %}
            </select>
        </td>
        <td class="batch-cell"><input type="text" class="batch-no" placeholder="Enter Batch Number" onchange="onBatchChange(this, ${productRowCount})" required></td>
        <td class="expiry-cell"><input type="text" class="expiry" placeholder="MM-YYYY" title="Expiry in MM-YYYY format" required></td>
        <td class="mrp-cell"><input type="number" class="mrp" step="0.01" placeholder="0.00" min="0" required></td>
        <td class="rate-cell"><input type="number" class="return-rate" step="0.01" placeholder="0.00" min="0" onchange="calculateRowTotal(${productRowCount})" required></td>
        <td class="qty-cell"><input type="number" class="return-quantity" step="0.01" placeholder="0" min="0.01" onchange="calculateRowTotal(${productRowCount})" required></td>
        <td class="discount-cell"><input type="number" class="discount" step="0.01" placeholder="0.00" min="0" onchange="calculateRowTotal(${productRowCount})" value="0"></td>
        <td class="gst-cell"><input type="number" class="gst" step="0.01" placeholder="0.00" min="0" max="100" onchange="calculateRowTotal(${productRowCount})" value="0"></td>
        <td class="total-cell"><strong class="row-total">₹0.00</strong></td>
        <td class="action-cell"><button type="button" class="sr-remove-btn" onclick="removeProductRow(${productRowCount})" title="Remove Product"><i class="fas fa-trash"></i></button></td>
    `;
    
    tbody.appendChild(row);
    productRowCount++;
    
    // Don't auto-focus on product select during initial load
    // Only focus when user manually adds a row
    if (productRowCount > 1) {
        setTimeout(() => {
            const productSelect = row.querySelector('.product-select');
            if (productSelect) {
                productSelect.focus();
            }
        }, 100);
    }
}

// Remove product row
function removeProductRow(index) {
    const row = document.getElementById(`productRow_${index}`);
    if (row) {
        row.remove();
        calculateGrandTotal();
    }
}

// Debounced row calculation to prevent excessive calculations
let calculationTimeout;
function calculateRowTotal(index) {
    clearTimeout(calculationTimeout);
    calculationTimeout = setTimeout(() => {
        const row = document.getElementById(`productRow_${index}`);
        if (!row) return;
        
        const rate = parseFloat(row.querySelector('.return-rate').value) || 0;
        const quantity = parseFloat(row.querySelector('.return-quantity').value) || 0;
        const discount = parseFloat(row.querySelector('.discount').value) || 0;
        const gst = parseFloat(row.querySelector('.gst').value) || 0;
        
        const baseAmount = rate * quantity;
        const discountedAmount = baseAmount - discount;
        const totalAmount = discountedAmount * (1 + (gst / 100));
        
        row.querySelector('.row-total').textContent = '₹' + totalAmount.toFixed(2);
        calculateGrandTotal();
        
        // Add visual feedback for completed rows
        if (rate > 0 && quantity > 0) {
            row.classList.add('table-success');
        } else {
            row.classList.remove('table-success');
        }
    }, 200);
}

// Calculate grand total
function calculateGrandTotal() {
    let grandTotal = 0;
    document.querySelectorAll('.row-total').forEach(span => {
        const value = span.textContent.replace('₹', '');
        grandTotal += parseFloat(value) || 0;
    });
    
    // Add transport charges if any
    const additionalCharges = parseFloat(document.getElementById('additionalCharges').value) || 0;
    const finalTotal = grandTotal + additionalCharges;
    
    document.getElementById('grandTotal').textContent = finalTotal.toFixed(2);
    
    // Show breakdown if additional charges exist
    if (additionalCharges > 0) {
        document.getElementById('grandTotal').innerHTML = `${grandTotal.toFixed(2)} + ${additionalCharges.toFixed(2)} = <strong>${finalTotal.toFixed(2)}</strong>`;
    }
}

// This function is now handled by the change event listener above

// Load customer rate type with enhanced display
function loadCustomerRateType(customerId) {
    const rateInfo = document.getElementById('customerRateInfo');
    const rateText = rateInfo.querySelector('.sr-customer-rate-text');
    
    if (!customerId) {
        rateInfo.style.display = 'none';
        selectedCustomerRateType = 'A'; // Reset to default
        return;
    }
    
    const customerSelect = document.getElementById('customerSelect');
    const selectedOption = customerSelect.querySelector(`option[value="${customerId}"]`);
    
    if (selectedOption) {
        const rateType = selectedOption.getAttribute('data-rate-type');
        const customerName = selectedOption.textContent;
        
        // Store customer rate type globally (extract A, B, C from customer type)
        if (rateType && rateType.includes('A') || rateType === 'Type-A') {
            selectedCustomerRateType = 'A';
        } else if (rateType && rateType.includes('B') || rateType === 'Type-B') {
            selectedCustomerRateType = 'B';
        } else if (rateType && rateType.includes('C') || rateType === 'Type-C') {
            selectedCustomerRateType = 'C';
        } else {
            selectedCustomerRateType = 'A'; // Default
        }
        
        rateText.innerHTML = `<i class="fas fa-user"></i> Customer Type: <strong>${rateType || 'Type-A'}</strong> | Rate: <strong>Rate ${selectedCustomerRateType}</strong>`;
        rateInfo.style.display = 'block';
        
        console.log(`Customer ${customerName} has rate type: ${rateType}, using Rate ${selectedCustomerRateType}`);
        
        // Update any existing product rows with new rate type
        const productRows = document.querySelectorAll('#productsTableBody tr');
        productRows.forEach((row, index) => {
            const productSelect = row.querySelector('.product-select');
            const batchInput = row.querySelector('.batch-no');
            
            if (productSelect && productSelect.value && batchInput && batchInput.value) {
                const rowIndex = row.id.replace('productRow', '');
                loadBatchRateForCustomer(productSelect.value, batchInput.value, rowIndex);
            }
        });
    }
}

// This will be handled in DOMContentLoaded event

// Form submission
document.getElementById('salesReturnForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Collect products data
    const productsData = [];
    const rows = document.querySelectorAll('#productsTableBody tr');
    
    rows.forEach(row => {
        const productSelect = row.querySelector('.product-select');
        if (productSelect && productSelect.value) { // If product is selected
            productsData.push({
                productid: productSelect.value,
                batch_no: row.querySelector('.batch-no').value,
                expiry: row.querySelector('.expiry').value,
                mrp: row.querySelector('.mrp').value,
                return_rate: row.querySelector('.return-rate').value,
                return_quantity: row.querySelector('.return-quantity').value,
                discount: row.querySelector('.discount').value,
                gst: row.querySelector('.gst').value
            });
        }
    });
    
    document.getElementById('productsData').value = JSON.stringify(productsData);
    this.submit();
});

// Quick product search functionality
function openQuickProductSearch() {
    const existingModal = document.getElementById('quickProductModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    const modalHTML = `
        <div id="quickProductModal" class="quick-search-overlay">
            <div class="quick-search-content">
                <div class="quick-search-header">
                    <h4>🔍 Quick Product Search</h4>
                    <small>Type product name and press Enter</small>
                </div>
                <div class="quick-search-input">
                    <input type="text" id="quickProductInput" placeholder="Type product name..." onkeyup="quickSearchProducts(event)">
                </div>
                <div class="quick-search-results" id="quickResults"></div>
                <div class="quick-search-footer">
                    <small>↑↓: Navigate | Enter: Select | Esc: Close</small>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    setTimeout(() => {
        const input = document.getElementById('quickProductInput');
        input.focus();
        
        input.addEventListener('keydown', function(e) {
            const resultsDiv = document.getElementById('quickResults');
            
            switch(e.key) {
                case 'Escape':
                    closeQuickSearch();
                    break;
                    
                case 'ArrowDown':
                    e.preventDefault();
                    navigateResults(1);
                    break;
                    
                case 'ArrowUp':
                    e.preventDefault();
                    navigateResults(-1);
                    break;
                    
                case 'Enter':
                    e.preventDefault();
                    const selected = resultsDiv.querySelector('.selected') || resultsDiv.querySelector('.quick-result-item');
                    if (selected) {
                        selected.click(); // Use click event to prevent double execution
                    }
                    break;
            }
        });
    }, 100);
}

function quickSearchProducts(event) {
    const originalSearchTerm = event.target.value;
    const searchTerm = originalSearchTerm.toLowerCase();
    const resultsDiv = document.getElementById('quickResults');
    
    if (['ArrowDown', 'ArrowUp', 'Enter', 'Escape'].includes(event.key)) {
        return;
    }
    
    if (originalSearchTerm.length < 2) {
        resultsDiv.innerHTML = '<div class="quick-hint">Type at least 2 characters...</div>';
        return;
    }
    
    const products = [{% for product in products %}{
        id: {{ product.productid }},
        name: '{{ product.product_name|escapejs }}',
        company: '{{ product.product_company|escapejs }}'
    },{% endfor %}];
    
    // Filter products that START with the search term (first 2+ letters)
    const filtered = products.filter(p => {
        // Primary filter: starts with search term (case-sensitive first, then case-insensitive)
        const exactStartsName = p.name.startsWith(originalSearchTerm);
        const exactStartsCompany = p.company.startsWith(originalSearchTerm);
        const startsName = p.name.toLowerCase().startsWith(searchTerm);
        const startsCompany = p.company.toLowerCase().startsWith(searchTerm);
        
        return exactStartsName || exactStartsCompany || startsName || startsCompany;
    }).sort((a, b) => {
        // Priority scoring for "starts with" matches
        let aScore = 0;
        let bScore = 0;
        
        // Exact case "starts with" gets highest priority (100 points)
        if (a.name.startsWith(originalSearchTerm)) aScore += 100;
        if (a.company.startsWith(originalSearchTerm)) aScore += 90;
        if (b.name.startsWith(originalSearchTerm)) bScore += 100;
        if (b.company.startsWith(originalSearchTerm)) bScore += 90;
        
        // Case-insensitive "starts with" gets medium priority (50 points)
        if (a.name.toLowerCase().startsWith(searchTerm)) aScore += 50;
        if (a.company.toLowerCase().startsWith(searchTerm)) aScore += 40;
        if (b.name.toLowerCase().startsWith(searchTerm)) bScore += 50;
        if (b.company.toLowerCase().startsWith(searchTerm)) bScore += 40;
        
        // Sort by score (higher score first)
        if (aScore !== bScore) {
            return bScore - aScore;
        }
        
        // If scores are equal, sort alphabetically
        return a.name.localeCompare(b.name);
    });
    
    if (filtered.length === 0) {
        resultsDiv.innerHTML = '<div class="no-results">No products starting with "' + originalSearchTerm + '" found</div>';
        return;
    }
    
    resultsDiv.innerHTML = filtered.map((product, index) => `
        <div class="quick-result-item ${index === 0 ? 'selected' : ''}" 
             onclick="quickSelectProduct(${product.id}, '${product.name.replace(/'/g, "\\'").replace(/"/g, '\\"')}', '${product.company.replace(/'/g, "\\'").replace(/"/g, '\\"')}')">
            <div class="product-name">${product.name}</div>
            <div class="product-company">${product.company}</div>
        </div>
    `).join('');
}

function navigateResults(direction) {
    const items = document.querySelectorAll('.quick-result-item');
    if (items.length === 0) return;
    
    const current = document.querySelector('.quick-result-item.selected');
    let newIndex = 0;
    
    if (current) {
        const currentIndex = Array.from(items).indexOf(current);
        newIndex = currentIndex + direction;
        
        if (newIndex < 0) newIndex = items.length - 1;
        else if (newIndex >= items.length) newIndex = 0;
        
        current.classList.remove('selected');
    }
    
    items[newIndex].classList.add('selected');
    items[newIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function quickSelectProduct(productId, productName, productCompany) {
    // Close modal immediately to prevent double-click issues
    closeQuickSearch();
    
    const rows = document.querySelectorAll('#productsTableBody tr');
    let targetRow = null;
    
    for (let row of rows) {
        const productSelect = row.querySelector('.product-select');
        if (productSelect && !productSelect.value) {
            targetRow = row;
            break;
        }
    }
    
    if (!targetRow) {
        addProductRow();
        setTimeout(() => {
            const newRows = document.querySelectorAll('#productsTableBody tr');
            targetRow = newRows[newRows.length - 1];
            fillProductInRow(targetRow, productId);
        }, 100);
    } else {
        fillProductInRow(targetRow, productId);
    }
}

function fillProductInRow(row, productId) {
    const productSelect = row.querySelector('.product-select');
    if (productSelect && !productSelect.value) { // Only fill if empty
        productSelect.value = productId;
        
        const rowIndex = row.id.replace('productRow_', '');
        loadProductDetails(productSelect, rowIndex);
        
        setTimeout(() => {
            const batchField = row.querySelector('.batch-no');
            if (batchField) {
                batchField.focus();
                batchField.select();
            }
        }, 300);
    }
}

function closeQuickSearch() {
    const modal = document.getElementById('quickProductModal');
    if (modal) {
        modal.remove();
    }
}

// Batch selection functionality
function showBatchSelectionDialog(productId, rowIndex) {
    fetch(`/api/product-batch-selector/?product_id=${productId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.batches.length > 0) {
                createBatchSelectionModal(data.batches, rowIndex);
            } else {
                alert('No batches found for this product.');
            }
        })
        .catch(error => {
            console.error('Error fetching batches:', error);
            alert('Error loading batch information.');
        });
}

function createBatchSelectionModal(batches, rowIndex) {
    const existingModal = document.getElementById('batchSelectionModal');
    if (existingModal) existingModal.remove();
    
    const modalHTML = `
        <div id="batchSelectionModal" class="batch-modal-overlay">
            <div class="batch-modal-content">
                <div class="batch-modal-header">
                    <h3>Select Batch</h3>
                    <button type="button" class="batch-modal-close" onclick="closeBatchModal()">&times;</button>
                </div>
                <div class="batch-modal-body">
                    <div class="batch-search">
                        <input type="text" id="batchSearch" placeholder="Search batch..." onkeyup="filterBatches()">
                    </div>
                    <div class="batch-list" id="batchList">
                        ${batches.map(batch => {
                            const rateA = batch.rates?.rate_A || batch.mrp || 0;
                            const rateB = batch.rates?.rate_B || batch.mrp || 0;
                            const rateC = batch.rates?.rate_C || batch.mrp || 0;
                            return `
                            <div class="batch-item" onclick="selectBatch('${batch.batch_no}', ${rowIndex}, ${JSON.stringify(batch).replace(/"/g, '&quot;')})">
                                <div class="batch-info">
                                    <div class="batch-no"><strong>${batch.batch_no}</strong></div>
                                    <div class="batch-details">
                                        <span>Exp: ${batch.expiry}</span>
                                        <span>Stock: ${batch.stock}</span>
                                        <span>MRP: ₹${batch.mrp}</span>
                                    </div>
                                    <div class="batch-rates">
                                        <span class="rate-badge">Rate A: ₹${rateA}</span>
                                        <span class="rate-badge">Rate B: ₹${rateB}</span>
                                        <span class="rate-badge">Rate C: ₹${rateC}</span>
                                    </div>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                </div>
                <div class="batch-modal-footer">
                    <div class="batch-shortcuts">
                        <small>↑↓: Navigate | Enter: Select | Esc: Close</small>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="closeBatchModal()">Cancel</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    setTimeout(() => {
        const searchInput = document.getElementById('batchSearch');
        searchInput.focus();
        
        const firstBatch = document.querySelector('.batch-item');
        if (firstBatch) firstBatch.classList.add('batch-selected');
        
        searchInput.addEventListener('keydown', function(e) {
            const visibleItems = document.querySelectorAll('.batch-item:not([style*="display: none"])');
            let selectedIndex = Array.from(visibleItems).findIndex(item => item.classList.contains('batch-selected'));
            
            switch(e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    if (selectedIndex < visibleItems.length - 1) {
                        if (selectedIndex >= 0) visibleItems[selectedIndex].classList.remove('batch-selected');
                        selectedIndex++;
                        visibleItems[selectedIndex].classList.add('batch-selected');
                        visibleItems[selectedIndex].scrollIntoView({ block: 'nearest' });
                    }
                    break;
                    
                case 'ArrowUp':
                    e.preventDefault();
                    if (selectedIndex > 0) {
                        visibleItems[selectedIndex].classList.remove('batch-selected');
                        selectedIndex--;
                        visibleItems[selectedIndex].classList.add('batch-selected');
                        visibleItems[selectedIndex].scrollIntoView({ block: 'nearest' });
                    }
                    break;
                    
                case 'Enter':
                    e.preventDefault();
                    if (selectedIndex >= 0 && visibleItems[selectedIndex]) {
                        visibleItems[selectedIndex].click();
                    }
                    break;
                    
                case 'Escape':
                    e.preventDefault();
                    closeBatchModal();
                    break;
            }
        });
    }, 100);
}

function selectBatch(batchNo, rowIndex, batchData) {
    const row = document.getElementById(`productRow_${rowIndex}`);
    if (row) {
        // Clear existing batch info first
        const existingInfo = row.querySelector('.stock-info');
        if (existingInfo) existingInfo.remove();
        
        // Update all batch fields with new batch data
        row.querySelector('.batch-no').value = batchNo;
        row.querySelector('.expiry').value = batchData.expiry;
        row.querySelector('.mrp').value = batchData.mrp;
        
        // Set rate based on customer type
        let selectedRate = batchData.mrp;
        if (batchData.rates && selectedCustomerRateType === 'A' && batchData.rates.rate_A > 0) {
            selectedRate = batchData.rates.rate_A;
        } else if (batchData.rates && selectedCustomerRateType === 'B' && batchData.rates.rate_B > 0) {
            selectedRate = batchData.rates.rate_B;
        } else if (batchData.rates && selectedCustomerRateType === 'C' && batchData.rates.rate_C > 0) {
            selectedRate = batchData.rates.rate_C;
        }
        
        row.querySelector('.return-rate').value = selectedRate;
        row.querySelector('.gst').value = batchData.gst_rate || '12';
        
        // Show updated stock info
        const stockInfo = document.createElement('small');
        stockInfo.className = 'text-success stock-info';
        stockInfo.innerHTML = `<i class="fas fa-info-circle"></i> Stock: ${batchData.stock} | Rate ${selectedCustomerRateType}: ₹${selectedRate}`;
        row.querySelector('.return-quantity').parentNode.appendChild(stockInfo);
        
        calculateRowTotal(rowIndex);
        
        // Focus on discount field after batch selection
        setTimeout(() => {
            const discountField = row.querySelector('.discount');
            if (discountField) {
                discountField.focus();
                discountField.select();
            }
        }, 100);
    }
    closeBatchModal();
}

function closeBatchModal() {
    const modal = document.getElementById('batchSelectionModal');
    if (modal) modal.remove();
}

function filterBatches() {
    const searchTerm = document.getElementById('batchSearch').value.toLowerCase();
    const batchItems = document.querySelectorAll('.batch-item');
    
    batchItems.forEach(item => {
        const batchNo = item.querySelector('.batch-no').textContent.toLowerCase();
        if (batchNo.includes(searchTerm)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

// This function is already defined above with proper implementation

// Auto-load product details when product is selected
function loadProductDetails(productSelect, rowIndex) {
    if (!productSelect.value) return;
    
    // Fetch available batches for the selected product
    fetch(`/api/product-batch-selector/?product_id=${productSelect.value}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.batches.length > 0) {
                const row = document.getElementById(`productRow_${rowIndex}`);
                const firstBatch = data.batches[0]; // Use first available batch
                
                // Auto-fill all fields with MM-YYYY expiry format
                row.querySelector('.batch-no').value = firstBatch.batch_no;
                row.querySelector('.expiry').value = firstBatch.expiry; // Already in MM-YYYY format from backend
                row.querySelector('.mrp').value = firstBatch.mrp;
                
                // Set rate based on customer type
                let selectedRate = firstBatch.mrp; // Default fallback
                if (firstBatch.rates && selectedCustomerRateType === 'A' && firstBatch.rates.rate_A > 0) {
                    selectedRate = firstBatch.rates.rate_A;
                } else if (firstBatch.rates && selectedCustomerRateType === 'B' && firstBatch.rates.rate_B > 0) {
                    selectedRate = firstBatch.rates.rate_B;
                } else if (firstBatch.rates && selectedCustomerRateType === 'C' && firstBatch.rates.rate_C > 0) {
                    selectedRate = firstBatch.rates.rate_C;
                }
                
                row.querySelector('.return-rate').value = selectedRate;
                row.querySelector('.return-quantity').value = '1';
                row.querySelector('.discount').value = '0';
                row.querySelector('.gst').value = '12';
                
                // Show stock info
                const stockInfo = document.createElement('small');
                stockInfo.className = 'text-success stock-info';
                stockInfo.innerHTML = `<i class="fas fa-info-circle"></i> Stock: ${firstBatch.stock} | Rate ${selectedCustomerRateType}: ₹${selectedRate}`;
                
                const existingInfo = row.querySelector('.stock-info');
                if (existingInfo) existingInfo.remove();
                
                row.querySelector('.return-quantity').parentNode.appendChild(stockInfo);
                
                // Trigger calculation
                calculateRowTotal(rowIndex);
                
                // Auto-focus on batch input after product selection
                setTimeout(() => {
                    const batchInput = row.querySelector('.batch-no');
                    if (batchInput) {
                        batchInput.focus();
                        batchInput.select();
                    }
                }, 150);
            }
        })
        .catch(error => {
            console.error('Error fetching product batches:', error);
        });
}

// Load batch rate based on customer type with enhanced matching
function loadBatchRateForCustomer(productId, batchNo, rowIndex) {
    const customerRateType = document.getElementById('customerRateType').value;
    
    if (!customerRateType) {
        return;
    }
    
    console.log(`Loading rate for Customer Type: ${customerRateType}, Product: ${productId}, Batch: ${batchNo}`);
    
    fetch(`/api/customer-rate-info/?product_id=${productId}&batch_no=${batchNo}&customer_type=${customerRateType}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const row = document.getElementById(`productRow${rowIndex}`);
                if (row) {
                    const rateField = row.querySelector('.return-rate');
                    let selectedRate = 0;
                    
                    // Enhanced rate matching logic
                    // Normalize customer type for comparison
                    const normalizedCustomerType = customerRateType.toUpperCase();
                    
                    // Match customer type to rate type with fallback hierarchy
                    if (normalizedCustomerType.includes('TYPE-A') || normalizedCustomerType.includes('RETAILER') || normalizedCustomerType === 'A') {
                        selectedRate = data.rate_A || data.mrp || 0;
                        console.log(`Applied Rate A: ${selectedRate}`);
                    } else if (normalizedCustomerType.includes('TYPE-B') || normalizedCustomerType.includes('WHOLESALER') || normalizedCustomerType === 'B') {
                        selectedRate = data.rate_B || data.rate_A || data.mrp || 0;
                        console.log(`Applied Rate B: ${selectedRate}`);
                    } else if (normalizedCustomerType.includes('TYPE-C') || normalizedCustomerType.includes('DISTRIBUTOR') || normalizedCustomerType === 'C') {
                        selectedRate = data.rate_C || data.rate_B || data.rate_A || data.mrp || 0;
                        console.log(`Applied Rate C: ${selectedRate}`);
                    } else {
                        // Default fallback to Rate A
                        selectedRate = data.rate_A || data.mrp || 0;
                        console.log(`Applied Default Rate A: ${selectedRate}`);
                    }
                    
                    rateField.value = selectedRate;
                    
                    // Show rate type indicator
                    const rateIndicator = row.querySelector('.rate-indicator') || document.createElement('small');
                    rateIndicator.className = 'rate-indicator';
                    rateIndicator.style.color = '#059669';
                    rateIndicator.style.display = 'block';
                    rateIndicator.style.marginTop = '4px';
                    rateIndicator.style.fontWeight = '500';
                    
                    let rateTypeUsed = 'A';
                    if (normalizedCustomerType.includes('TYPE-B') || normalizedCustomerType.includes('WHOLESALER')) {
                        rateTypeUsed = 'B';
                    } else if (normalizedCustomerType.includes('TYPE-C') || normalizedCustomerType.includes('DISTRIBUTOR')) {
                        rateTypeUsed = 'C';
                    }
                    
                    rateIndicator.innerHTML = `✓ Rate ${rateTypeUsed} applied for ${customerRateType}`;
                    
                    // Remove existing indicator
                    const existingIndicator = row.querySelector('.rate-indicator');
                    if (existingIndicator && existingIndicator !== rateIndicator) {
                        existingIndicator.remove();
                    }
                    
                    // Add indicator after rate field
                    const rateCell = rateField.parentElement;
                    if (!rateCell.querySelector('.rate-indicator')) {
                        rateCell.appendChild(rateIndicator);
                    }
                    
                    calculateRowTotal(rowIndex);
                }
            } else {
                console.error('Failed to fetch rate info:', data.error);
            }
        })
        .catch(error => {
            console.error('Error fetching batch rate:', error);
        });
}

// Handle batch number change with enhanced rate matching
function onBatchChange(batchInput, rowIndex) {
    const batchNo = batchInput.value.trim();
    const row = document.getElementById(`productRow${rowIndex}`);
    const productSelect = row.querySelector('.product-select');
    
    if (batchNo && productSelect.value) {
        // Clear any existing rate indicators
        const existingIndicator = row.querySelector('.rate-indicator');
        if (existingIndicator) {
            existingIndicator.remove();
        }
        
        // Load rate based on customer type and batch
        loadBatchRateForCustomer(productSelect.value, batchNo, rowIndex);
        validateBatchStock(productSelect.value, batchNo, rowIndex);
        
        // Show loading indicator
        const rateField = row.querySelector('.return-rate');
        const loadingIndicator = document.createElement('small');
        loadingIndicator.className = 'loading-indicator';
        loadingIndicator.style.color = '#6b7280';
        loadingIndicator.style.display = 'block';
        loadingIndicator.style.marginTop = '4px';
        loadingIndicator.textContent = '⏳ Loading rate...';
        
        const rateCell = rateField.parentElement;
        rateCell.appendChild(loadingIndicator);
        
        // Remove loading indicator after 2 seconds
        setTimeout(() => {
            if (loadingIndicator.parentElement) {
                loadingIndicator.remove();
            }
        }, 2000);
    }
}

// Validate batch stock availability
function validateBatchStock(productId, batchNo, rowIndex) {
    console.log(`Validating stock for Product ${productId}, Batch ${batchNo}`);
    
    fetch(`/get-batch-details/?product_id=${productId}&batch_no=${batchNo}`)
        .then(response => response.json())
        .then(data => {
            console.log('Stock validation response:', data);
            
            if (data.success) {
                const row = document.getElementById(`productRow${rowIndex}`);
                if (row) {
                    const stockInfo = document.createElement('small');
                    stockInfo.className = 'stock-info';
                    stockInfo.style.color = data.stock > 0 ? '#059669' : '#dc2626';
                    stockInfo.style.display = 'block';
                    stockInfo.style.marginTop = '4px';
                    stockInfo.style.fontWeight = '500';
                    
                    // Show detailed stock info if debug data is available
                    if (data.debug_info) {
                        stockInfo.innerHTML = `
                            <strong>Stock: ${data.stock} units</strong><br>
                            <span style="font-size: 0.7rem; color: #6b7280;">
                                Purchased: ${data.debug_info.purchased} | 
                                Sold: ${data.debug_info.sold} | 
                                P.Returns: ${data.debug_info.purchase_returns} | 
                                S.Returns: ${data.debug_info.sales_returns}
                            </span>
                        `;
                    } else {
                        stockInfo.textContent = `Stock: ${data.stock} units`;
                    }
                    
                    // Remove existing stock info
                    const existingInfo = row.querySelector('.stock-info');
                    if (existingInfo) {
                        existingInfo.remove();
                    }
                    
                    // Add stock info after batch input
                    const batchCell = row.querySelector('.batch-no').parentElement;
                    batchCell.appendChild(stockInfo);
                    
                    // Update quantity field max value and validation
                    const qtyField = row.querySelector('.return-quantity');
                    if (data.stock > 0) {
                        qtyField.max = data.stock;
                        qtyField.title = `Maximum available: ${data.stock}`;
                        qtyField.style.borderColor = '#d1d5db';
                    } else {
                        qtyField.max = '';
                        qtyField.title = 'No stock available for this batch';
                        qtyField.style.borderColor = '#dc2626';
                        qtyField.value = ''; // Clear quantity if no stock
                    }
                    
                    // Add real-time validation
                    qtyField.addEventListener('input', function() {
                        const enteredQty = parseFloat(this.value) || 0;
                        if (enteredQty > data.stock) {
                            this.style.borderColor = '#dc2626';
                            this.title = `Cannot exceed available stock: ${data.stock}`;
                        } else {
                            this.style.borderColor = '#d1d5db';
                            this.title = `Available: ${data.stock}`;
                        }
                    });
                }
            } else {
                console.error('Stock validation failed:', data.error);
                alert(`Error validating stock: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('Error validating batch stock:', error);
            alert('Error connecting to server for stock validation');
        });
}

// Enhanced keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // F2: Open quick product search
    if (e.key === 'F2') {
        e.preventDefault();
        openQuickProductSearch();
    }
    
    // Ctrl+Enter: Add new product row
    if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        addProductRow();
        // Focus on the new product select field
        setTimeout(() => {
            const newRows = document.querySelectorAll('#productsTableBody tr');
            const lastRow = newRows[newRows.length - 1];
            const productSelect = lastRow.querySelector('.product-select');
            if (productSelect) {
                productSelect.focus();
            }
        }, 100);
    }
    
    // Ctrl+S: Save form
    if (e.ctrlKey && e.key.toLowerCase() === 's') {
        e.preventDefault();
        const form = document.getElementById('salesReturnForm');
        if (form) {
            form.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
        }
    }
    
    // Alt + W for batch selection
    if (e.altKey && e.key.toLowerCase() === 'w') {
        e.preventDefault();
        const focusedElement = document.activeElement;
        if (focusedElement && focusedElement.classList.contains('batch-no')) {
            const row = focusedElement.closest('tr');
            const productSelect = row.querySelector('.product-select');
            const rowIndex = row.id.replace('productRow_', '');
            
            if (productSelect && productSelect.value) {
                showBatchSelectionDialog(productSelect.value, rowIndex);
            } else {
                alert('Please select a product first!');
            }
        }
    }
    
    // Escape: Clear current input or close modals
    if (e.key === 'Escape') {
        e.preventDefault();
        const focused = document.activeElement;
        if (focused.tagName === 'INPUT' || focused.tagName === 'SELECT') {
            if (focused.value) {
                focused.value = '';
                if (focused.onchange) focused.onchange();
            } else {
                focused.blur();
            }
        }
    }
});

// Batch input handler with immediate response
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('batch-no')) {
        const row = e.target.closest('tr');
        const productSelect = row.querySelector('.product-select');
        const rowIndex = row.id.split('_')[1];
        
        if (productSelect.value && e.target.value.trim()) {
            fetchBatchDetails(productSelect.value, e.target.value.trim(), rowIndex);
        }
    }
});

// Fetch batch details and auto-fill
function fetchBatchDetails(productId, batchNo, rowIndex) {
    fetch(`/api/batch-details/?product_id=${productId}&batch_no=${batchNo}`)
        .then(response => response.json())
        .then(data => {
            if (!data.error) {
                const row = document.getElementById(`productRow_${rowIndex}`);
                if (row) {
                    // Auto-fill fields
                    row.querySelector('.expiry').value = data.expiry || '';
                    row.querySelector('.mrp').value = data.mrp || '';
                    
                    // Set rate based on customer type
                    let selectedRate = data.mrp || 0;
                    if (data.rates && selectedCustomerRateType === 'A' && data.rates.rate_A > 0) {
                        selectedRate = data.rates.rate_A;
                    } else if (data.rates && selectedCustomerRateType === 'B' && data.rates.rate_B > 0) {
                        selectedRate = data.rates.rate_B;
                    } else if (data.rates && selectedCustomerRateType === 'C' && data.rates.rate_C > 0) {
                        selectedRate = data.rates.rate_C;
                    }
                    
                    row.querySelector('.return-rate').value = selectedRate;
                    row.querySelector('.gst').value = data.gst_rate || '12';
                    
                    calculateRowTotal(rowIndex);
                    
                    // Focus on discount field after batch details are loaded
                    setTimeout(() => {
                        const discountField = row.querySelector('.discount');
                        if (discountField) {
                            discountField.focus();
                            discountField.select();
                        }
                    }, 100);
                }
            }
        })
        .catch(error => console.error('Error fetching batch details:', error));
}

// Auto-fill current date and setup focus
function setCurrentDate() {
    const dateField = document.querySelector('[name="return_sales_invoice_date"]');
    if (dateField && !dateField.value) {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        dateField.value = `${year}-${month}-${day}`;
        console.log('✓ Return date auto-filled:', dateField.value);
    }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    console.log('Sales Return Form loaded, initializing...');
    
    // Auto-fill current date
    setCurrentDate();
    
    // Enhanced focus on return date field first
    function focusReturnDate() {
        const returnDateField = document.querySelector('[name="return_sales_invoice_date"]') ||
                               document.querySelector('#return_date');
        
        if (returnDateField) {
            returnDateField.focus();
            console.log('✓ Sales return date field focused:', returnDateField.name);
            return true;
        } else {
            console.error('❌ Sales return date field not found');
            return false;
        }
    }
    
    // Try multiple times with increasing delays
    setTimeout(focusReturnDate, 100);
    setTimeout(focusReturnDate, 300);
    setTimeout(focusReturnDate, 500);
    
    // Initialize with one product row
    setTimeout(() => {
        const tbody = document.getElementById('productsTableBody');
        if (tbody && tbody.children.length === 0) {
            addProductRow();
            console.log('✓ Single product row initialized');
        }
    }, 300);
    
    // Setup additional charges change handler
    const additionalChargesField = document.getElementById('additionalCharges');
    if (additionalChargesField) {
        additionalChargesField.addEventListener('input', calculateGrandTotal);
    }
    
    // Ensure page starts from top
    window.scrollTo(0, 0);
});
</script>

<style>
/* Quick Search Modal Styles */
.quick-search-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.quick-search-content {
    background: white;
    border-radius: 10px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.quick-search-header {
    background: #dc2626;
    color: white;
    padding: 20px;
    text-align: center;
}

.quick-search-header h4 {
    margin: 0 0 5px 0;
    font-size: 1.2rem;
}

.quick-search-input {
    padding: 20px;
}

.quick-search-input input {
    width: 100%;
    padding: 12px;
    border: 2px solid #e5e7eb;
    border-radius: 6px;
    font-size: 1rem;
    outline: none;
}

.quick-search-input input:focus {
    border-color: #dc2626;
    box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
}

.quick-search-results {
    max-height: 300px;
    overflow-y: auto;
    padding: 0 20px;
}

.quick-result-item {
    padding: 12px;
    border-bottom: 1px solid #e5e7eb;
    cursor: pointer;
    transition: background-color 0.2s;
}

.quick-result-item:hover,
.quick-result-item.selected {
    background: #f3f4f6;
}

.product-name {
    font-weight: 600;
    color: #374151;
}

.product-company {
    font-size: 0.9rem;
    color: #6b7280;
    margin-top: 2px;
}

.quick-hint,
.no-results {
    text-align: center;
    padding: 20px;
    color: #6b7280;
    font-style: italic;
}

.quick-search-footer {
    background: #f9fafb;
    padding: 15px 20px;
    text-align: center;
    border-top: 1px solid #e5e7eb;
}

/* Rate Type Indicators */
.rate-indicator {
    background: #f0fdf4;
    border: 1px solid #bbf7d0;
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 0.75rem;
    font-weight: 500;
    color: #059669;
    display: inline-block;
    margin-top: 4px;
}

.loading-indicator {
    color: #6b7280;
    font-size: 0.75rem;
    font-style: italic;
    animation: pulse 1.5s ease-in-out infinite alternate;
}

.customer-reminder {
    background: #fef3c7;
    border: 1px solid #fcd34d;
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 0.75rem;
    font-weight: 500;
    color: #92400e;
    display: inline-block;
    margin-top: 4px;
}

.quick-tip {
    background: #f0fdf4;
    border: 1px solid #bbf7d0;
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 0.75rem;
    font-weight: 500;
    color: #059669;
    display: inline-block;
    margin-top: 4px;
    animation: fadeIn 0.5s ease-in;
}

.batch-confirmation {
    background: #ecfdf5;
    border: 1px solid #a7f3d0;
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 0.75rem;
    font-weight: 500;
    color: #047857;
    display: inline-block;
    margin-top: 4px;
    animation: slideIn 0.3s ease-out;
}

@keyframes pulse {
    0% { opacity: 0.6; }
    100% { opacity: 1; }
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes slideIn {
    from { opacity: 0; transform: translateX(-10px); }
    to { opacity: 1; transform: translateX(0); }
}

/* Enhanced customer rate type field */
#customerRateType {
    font-weight: 600;
    text-align: center;
    background: #f8fafc;
    border: 2px solid #e2e8f0;
    transition: all 0.3s ease;
}

#customerRateType:focus {
    background: #f0fdf4;
    border-color: #059669;
    box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
}

/* Footer with shortcuts */
.sr-shortcuts-footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #1f2937;
    color: #d1d5db;
    padding: 10px 20px;
    font-size: 0.8rem;
    display: flex;
    justify-content: center;
    gap: 30px;
    z-index: 100;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
}

.sr-shortcut-item {
    display: flex;
    align-items: center;
    gap: 5px;
}

.sr-shortcut-key {
    background: #374151;
    padding: 2px 6px;
    border-radius: 3px;
    font-weight: 600;
    font-size: 0.7rem;
}
</style>

<!-- Keyboard Shortcuts Footer -->
<div class="sr-shortcuts-footer">
    <div class="sr-shortcut-item">
        <span class="sr-shortcut-key">F2</span>
        <span>Quick Search</span>
    </div>
    <div class="sr-shortcut-item">
        <span class="sr-shortcut-key">Ctrl+Enter</span>
        <span>Add Product</span>
    </div>
    <div class="sr-shortcut-item">
        <span class="sr-shortcut-key">Alt+W</span>
        <span>Batch Selector</span>
    </div>
    <div class="sr-shortcut-item">
        <span class="sr-shortcut-key">Esc</span>
        <span>Close Modal</span>
    </div>
    <div class="sr-shortcut-item">
        <span class="sr-shortcut-key">Ctrl+S</span>
        <span>Save Return</span>
    </div>
</div>
{% endblock %}