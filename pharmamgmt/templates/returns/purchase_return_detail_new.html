{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div >
    <div >
        <div >
            <div >
                <div >
                    <h5 >Purchase Return #{{ return_invoice.returninvoiceid }}</h5>
                    <div role="group">
                        <a href="{% url 'add_purchase_return_item' return_id=return_invoice.returninvoiceid %}" >
                            <i class="fas fa-plus-circle me-1"></i>Add Product
                        </a>
                        <a href="{% url 'delete_purchase_return' pk=return_invoice.returninvoiceid %}" >
                            <i class="fas fa-trash me-1"></i>Delete Return
                        </a>
                        <a href="{% url 'purchase_return_list' %}" >
                            <i class="fas fa-arrow-left me-1"></i>Back to List
                        </a>
                    </div>
                </div>
                <div >
                    <!-- Return details section -->
                    <div >
                        <div >
                            <h6 >Return Details</h6>
                            <ul class="list-unstyled">
                                <li><strong>Return No:</strong> {{ return_invoice.returninvoiceid }}</li>
                                <li><strong>Date:</strong> {{ return_invoice.returninvoice_date }}</li>
                                <li><strong>Supplier:</strong> {{ return_invoice.returnsupplierid.supplier_name }}</li>
                                <li><strong>Contact:</strong> {{ return_invoice.returnsupplierid.supplier_mobile }}</li>
                            </ul>
                        </div>
                        <div >
                            <h6 >Financial Summary</h6>
                            <ul class="list-unstyled">
                                <li><strong>Return Total:</strong> ₹{{ return_invoice.returninvoice_total|floatformat:2 }}</li>
                                <li><strong>Charged Back:</strong> ₹{{ return_invoice.returninvoice_paid|floatformat:2 }}</li>
                                <li><strong>Balance:</strong> ₹{{ return_invoice.balance_due|floatformat:2 }}</li>
                                <li><strong>Extra Charges:</strong> ₹{{ return_invoice.return_charges|floatformat:2 }}</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Returned products table -->
                    <h6 >Returned Products</h6>
                    {% if returns %}
                    <div >
                        <table >
                            <thead >
                                <tr>
                                    <th>Product</th>
                                    <th>Batch No</th>
                                    <th>Expiry</th>
                                    <th>MRP</th>
                                    <th>Purchase Rate</th>
                                    <th>Quantity</th>
                                    <th>Amount</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in returns %}
                                <tr>
                                    <td>{{ item.returnproduct_name }} {% if item.returnproduct_packing %}({{ item.returnproduct_packing }}){% endif %}</td>
                                    <td>{{ item.returnproduct_batch_no }}</td>
                                    <td>{{ item.returnproduct_expiry|date:"M Y" }}</td>
                                    <td>₹{{ item.returnproduct_MRP|floatformat:2 }}</td>
                                    <td>₹{{ item.returnproduct_purchase_rate|floatformat:2 }}</td>
                                    <td>{{ item.returnproduct_quantity }}</td>
                                    <td>₹{{ item.returntotal_amount|floatformat:2 }}</td>
                                    <td>
                                        <div role="group">
                                            <a href="{% url 'delete_purchase_return_item' return_id=return_invoice.returninvoiceid item_id=item.id %}" >
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr >
                                    <td colspan="6" >Total:</td>
                                    <td colspan="2">₹{{ returns|sum_field:'returntotal_amount'|floatformat:2 }}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    {% else %}
                    <div >
                        <i class="fas fa-info-circle me-2"></i>No products have been added to this return yet.
                        <a href="{% url 'add_purchase_return_item' return_id=return_invoice.returninvoiceid %}" >Add one now</a>.
                    </div>
                    {% endif %}

                    <!-- Payments section -->
                    <h6 >Refund Payments</h6>
                    {% if payments %}
                    <div >
                        <table >
                            <thead >
                                <tr>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Mode</th>
                                    <th>Reference</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payment in payments %}
                                <tr>
                                    <td>{{ payment.payment_date|date:"d-m-Y" }}</td>
                                    <td>₹{{ payment.payment_amount|floatformat:2 }}</td>
                                    <td>{{ payment.payment_mode }}</td>
                                    <td>{{ payment.payment_ref_no }}</td>
                                    <td>
                                        <div role="group">
                                            <a href="#" >
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr >
                                    <td colspan="1" >Total Refunded:</td>
                                    <td colspan="4">₹{{ payments|sum_field:'payment_amount'|floatformat:2 }}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    {% else %}
                    <div >
                        <i class="fas fa-info-circle me-2"></i>No refund payments have been recorded for this return yet.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}







