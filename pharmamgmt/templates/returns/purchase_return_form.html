{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="{% static 'css/purchase_return_form.css' %}">
<link rel="stylesheet" href="{% static 'css/combined_invoice_form.css' %}">
<link rel="stylesheet" href="{% static 'css/ci_unique_styles.css' %}">
{% endblock %}

{% block content %}
<div class="ci-main-container">
    <div class="ci-wrapper-card">
        <div class="ci-page-header">
            <h5 class="ci-main-title">
                <i class="fas fa-undo text-warning"></i> New Purchase Return
            </h5>
        </div>
        
        <div class="ci-content-body">
            <form method="post" id="purchaseReturnForm" class="ci-main-form">
                {% csrf_token %}
                
                <!-- Return Invoice Details Section -->
                <div class="ci-invoice-details-section">
                    <h6 class="ci-section-title">Return Invoice Details</h6>
                    
                    <div class="return-id-preview">
                        <strong>Return ID:</strong> {{ preview_id }}
                    </div>
                    
                    <div class="ci-form-row">
                        <div class="ci-form-column">
                            <div class="ci-supplier-field-group">
                                <label for="{{ form.returnsupplierid.id_for_label }}" class="ci-supplier-label required">Supplier*</label>
                                {{ form.returnsupplierid }}
                                {% if form.returnsupplierid.errors %}
                                    <div class="invalid-feedback d-block">{{ form.returnsupplierid.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="ci-form-column">
                            <div class="ci-field-group">
                                <label for="{{ form.returninvoice_date.id_for_label }}" class="ci-field-label required">Return Date*</label>
                                {{ form.returninvoice_date }}
                                {% if form.returninvoice_date.errors %}
                                    <div class="invalid-feedback d-block">{{ form.returninvoice_date.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="ci-form-row">
                        <div class="ci-form-column">
                            <div class="ci-field-group">
                                <label for="{{ form.return_charges.id_for_label }}" class="ci-field-label">Return Charges</label>
                                {{ form.return_charges }}
                                {% if form.return_charges.errors %}
                                    <div class="invalid-feedback d-block">{{ form.return_charges.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="ci-form-column">
                            <div class="ci-field-group">
                                <label for="{{ form.returninvoice_total.id_for_label }}" class="ci-field-label required">Return Total*</label>
                                {{ form.returninvoice_total }}

                                {% if form.returninvoice_total.errors %}
                                    <div class="invalid-feedback d-block">{{ form.returninvoice_total.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Products Section -->
                <div class="ci-products-section">
                    <div class="ci-products-header">
                        <div class="ci-products-title-area">
                            <h6 class="ci-section-title">Return Products</h6>
                            <small class="ci-keyboard-shortcuts">F2: Search | Ctrl+Enter: Add | Ctrl+S: Save</small>
                        </div>
                        <button type="button" class="ci-add-product-btn" onclick="addReturnProductRow()">
                            <i class="fas fa-plus"></i> Add Product
                        </button>
                    </div>
                    <div class="ci-table-container">
                        <table class="ci-products-table" id="returnProductsTable">
                            <thead class="ci-table-header">
                                <tr class="ci-header-row">
                                    <th class="ci-th-product">Product</th>
                                    <th class="ci-th-batch">Batch No</th>
                                    <th class="ci-th-expiry">Expiry</th>
                                    <th class="ci-th-mrp">MRP</th>
                                    <th class="ci-th-purchase-rate">Return Rate</th>
                                    <th class="ci-th-qty">Return Qty</th>
                                    <th class="ci-th-discount">Scheme</th>
                                    <th class="ci-th-charges">Charges</th>
                                    <th class="ci-th-reason">Reason</th>
                                    <th class="ci-th-total">Total</th>
                                    <th class="ci-th-action">Action</th>
                                </tr>
                            </thead>
                            <tbody id="returnProductRows" class="ci-table-body">
                                <!-- Return product rows will be added here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="ci-total-section">
                        <div class="ci-grand-total-display">
                            <strong class="ci-total-text">Return Total: ₹<span id="returnTotal" class="ci-total-amount">0.00</span></strong>
                        </div>
                    </div>
                </div>

                <!-- Hidden field for products data -->
                <input type="hidden" name="products_data" id="returnProductsData">

                <!-- Submit Button -->
                <div class="ci-form-actions">
                    <button type="submit" class="ci-save-btn" id="saveReturnBtn">
                        <i class="fas fa-save"></i> Save Purchase Return
                    </button>

                </div>
                
                <!-- Messages -->
                {% if messages %}
                <div class="ci-messages-section">
                    {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </form>
        </div>
    </div>
</div>








<script>
let returnProductRowIndex = 0;

function addReturnProductRow() {
    const tbody = document.getElementById('returnProductRows');
    const row = document.createElement('tr');
    row.id = `returnProductRow_${returnProductRowIndex}`;
    
    row.innerHTML = `
        <td><select class="product-select" onchange="loadReturnProductInfo(${returnProductRowIndex}, this.value)" required>
            <option value="">Select Product</option>
            {% for product in products %}
            <option value="{{ product.productid }}">{{ product.product_name }} - {{ product.product_company }}</option>
            {% endfor %}
        </select></td>
        <td><input type="text" class="batch-no" placeholder="Batch No" required></td>
        <td><input type="text" class="expiry date-input" placeholder="MM-YYYY" maxlength="8" required></td>
        <td><input type="number" class="mrp" step="0.01" placeholder="MRP" min="0.01" required></td>
        <td><input type="number" class="return-rate" step="0.01" placeholder="Return Rate" min="0.01" onchange="calculateReturnRowTotal(${returnProductRowIndex})" required></td>
        <td>
            <input type="number" class="return-qty" placeholder="Return Qty" min="0.01" step="0.01" 
                   oninput="validateReturnStockAndCalculate(${returnProductRowIndex})" 
                   onchange="validateReturnStockAndCalculate(${returnProductRowIndex})" 
                   onblur="validateReturnStockAndCalculate(${returnProductRowIndex})" required>
            <div class="available-stock" style="font-size: 0.8rem; color: #666; margin-top: 2px;"></div>
            <div class="stock-error" style="display: none; color: #dc3545; font-size: 0.75rem; margin-top: 4px; padding: 2px 4px; background: #f8d7da; border-radius: 3px; border-left: 3px solid #dc3545;"></div>
        </td>
        <td><input type="number" class="scheme" step="0.01" placeholder="Scheme" min="0" onchange="calculateReturnRowTotal(${returnProductRowIndex})"></td>
        <td><input type="number" class="charges" step="0.01" placeholder="Charges" min="0" onchange="calculateReturnRowTotal(${returnProductRowIndex})"></td>
        <td><input type="text" class="reason" placeholder="Return Reason" maxlength="200"></td>
        <td><span class="return-row-total">0.00</span></td>
        <td><button type="button" class="remove-btn" onclick="removeReturnProductRow(${returnProductRowIndex})" title="Remove Row"><i class="fas fa-trash"></i></button></td>
    `;
    
    tbody.appendChild(row);
    returnProductRowIndex++;
    
    setTimeout(() => {
        const newRow = document.getElementById(`returnProductRow_${returnProductRowIndex - 1}`);
        if (newRow) {
            newRow.querySelector('.product-select')?.focus();
        }
    }, 100);
}

function removeReturnProductRow(rowIndex) {
    const row = document.getElementById(`returnProductRow_${rowIndex}`);
    if (row) {
        row.remove();
        calculateReturnTotal();
    }
}

// Stock validation function for purchase returns
function validateReturnStockAndCalculate(rowIndex) {
    const row = document.getElementById(`returnProductRow_${rowIndex}`);
    if (!row) return;
    
    const quantityInput = row.querySelector('.return-qty');
    const stockError = row.querySelector('.stock-error');
    const stockInfo = row.querySelector('.available-stock');
    const quantity = parseFloat(quantityInput.value) || 0;
    
    // Get available stock from stock info
    let availableStock = 0;
    if (stockInfo && stockInfo.textContent) {
        const stockMatch = stockInfo.textContent.match(/Available: (\d+(?:\.\d+)?)/i);
        if (stockMatch) {
            availableStock = parseFloat(stockMatch[1]);
        }
    }
    
    console.log(`🔍 Return Stock Validation - Row ${rowIndex}: Quantity=${quantity}, Available=${availableStock}`);
    
    // Validate stock for return - can't return more than available
    if (availableStock >= 0 && quantity > availableStock) {
        // Show error message
        const errorMsg = availableStock === 0 
            ? 'No stock available for return!' 
            : `Insufficient stock for return! Available: ${availableStock} units`;
        
        console.log(`❌ Return Stock Error - Row ${rowIndex}: ${errorMsg}`);
        
        stockError.textContent = errorMsg;
        stockError.style.display = 'block';
        stockError.style.color = '#dc3545';
        stockError.style.fontWeight = 'bold';
        
        // Style the input with error state
        quantityInput.style.borderColor = '#dc3545';
        quantityInput.style.backgroundColor = '#f8d7da';
        quantityInput.style.boxShadow = '0 0 0 0.2rem rgba(220, 53, 69, 0.25)';
        
        // Mark input as having stock error
        quantityInput.setAttribute('data-stock-error', 'true');
        quantityInput.setAttribute('data-max-stock', availableStock);
        
        // Lock the form and prevent submission
        lockReturnFormInputs(true);
        
        // Add visual indicator to the row
        row.classList.add('stock-error-row');
        
        return false; // Indicate validation failed
    } else {
        console.log(`✅ Return Stock Valid - Row ${rowIndex}: Quantity within limits`);
        
        // Clear error state
        stockError.style.display = 'none';
        quantityInput.style.borderColor = '';
        quantityInput.style.backgroundColor = '';
        quantityInput.style.boxShadow = '';
        quantityInput.removeAttribute('data-stock-error');
        quantityInput.removeAttribute('data-max-stock');
        
        // Remove error styling from row
        row.classList.remove('stock-error-row');
        
        // Unlock form if no other stock errors exist
        if (!document.querySelector('input[data-stock-error="true"]')) {
            lockReturnFormInputs(false);
        }
    }
    
    calculateReturnRowTotal(rowIndex);
    return true; // Indicate validation passed
}

// Function to lock/unlock return form inputs
function lockReturnFormInputs(lock) {
    const form = document.getElementById('purchaseReturnForm');
    const inputs = form.querySelectorAll('input:not(.return-qty[data-stock-error="true"]), select, button[type="submit"], .ci-add-product-btn, .remove-btn');
    
    inputs.forEach(input => {
        if (lock) {
            input.disabled = true;
            input.style.opacity = '0.5';
            input.style.pointerEvents = 'none';
            input.setAttribute('data-locked', 'true');
        } else {
            input.disabled = false;
            input.style.opacity = '1';
            input.style.pointerEvents = 'auto';
            input.removeAttribute('data-locked');
        }
    });
    
    // Store lock state globally
    window.returnFormLocked = lock;
    
    // Show/hide overlay
    let overlay = document.getElementById('returnStockErrorOverlay');
    if (lock && !overlay) {
        overlay = document.createElement('div');
        overlay.id = 'returnStockErrorOverlay';
        overlay.innerHTML = `
            <div style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); 
                        background: linear-gradient(135deg, #dc3545, #c82333); color: white; 
                        padding: 20px 30px; border-radius: 12px; z-index: 10000; 
                        font-weight: bold; box-shadow: 0 8px 25px rgba(220, 53, 69, 0.4);
                        border: 2px solid rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px);">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 1.2rem;"></i>
                    <div>
                        <div style="font-size: 1.1rem; margin-bottom: 5px;">Return Stock Validation Error</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Correct the return quantity to continue</div>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(overlay);
        
        // Auto-hide overlay after 5 seconds
        setTimeout(() => {
            if (overlay && overlay.parentNode) {
                overlay.style.opacity = '0';
                overlay.style.transform = 'translateX(-50%) translateY(-20px)';
                setTimeout(() => overlay.remove(), 300);
            }
        }, 5000);
    } else if (!lock && overlay) {
        overlay.style.opacity = '0';
        overlay.style.transform = 'translateX(-50%) translateY(-20px)';
        setTimeout(() => overlay.remove(), 300);
    }
    
    // Update form submission button state
    const submitBtn = form.querySelector('button[type="submit"]');
    if (submitBtn) {
        if (lock) {
            submitBtn.innerHTML = '<i class="fas fa-ban"></i> Fix Stock Errors First';
            submitBtn.classList.add('btn-danger');
            submitBtn.classList.remove('ci-save-btn');
        } else {
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Save Purchase Return';
            submitBtn.classList.add('ci-save-btn');
            submitBtn.classList.remove('btn-danger');
        }
    }
}

function calculateReturnRowTotal(rowIndex) {
    const row = document.getElementById(`returnProductRow_${rowIndex}`);
    if (!row) return;
    
    const rate = parseFloat(row.querySelector('.return-rate').value) || 0;
    const qty = parseFloat(row.querySelector('.return-qty').value) || 0;
    const scheme = parseFloat(row.querySelector('.scheme').value) || 0;
    const charges = parseFloat(row.querySelector('.charges').value) || 0;
    
    const subtotal = rate * qty;
    const afterScheme = subtotal - scheme;
    const total = afterScheme + charges;
    
    row.querySelector('.return-row-total').textContent = total.toFixed(2);
    calculateReturnTotal();
}

function calculateReturnTotal() {
    let total = 0;
    document.querySelectorAll('.return-row-total').forEach(span => {
        total += parseFloat(span.textContent) || 0;
    });
    
    const returnCharges = parseFloat(document.querySelector('input[name*="return_charges"]')?.value) || 0;
    total += returnCharges;
    
    document.getElementById('returnTotal').textContent = total.toFixed(2);
    
    const returnTotalInput = document.querySelector('input[name*="returninvoice_total"]');
    if (returnTotalInput) {
        returnTotalInput.value = total.toFixed(2);
    }
}
function setCurrentReturnDate() {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    const dateString = `${day}${month}${year}`; // DDMMYYYY format
    
    const returnDateInput = document.querySelector('input[name*="returninvoice_date"]');
    if (returnDateInput) {
        returnDateInput.value = dateString;
        returnDateInput.removeAttribute('readonly');
    }
}



function loadReturnProductInfo(rowIndex, productId) {
    if (!productId) {
        const row = document.getElementById(`returnProductRow_${rowIndex}`);
        if (row) {
            row.querySelector('.batch-no').value = '';
            row.querySelector('.expiry').value = '';
            row.querySelector('.mrp').value = '';
            row.querySelector('.return-rate').value = '';
            row.querySelector('.available-stock').textContent = '';
            calculateReturnRowTotal(rowIndex);
        }
        return;
    }
    
    fetch(`/get-product-info/?product_id=${productId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error:', data.error);
                return;
            }
            
            const row = document.getElementById(`returnProductRow_${rowIndex}`);
            if (row) {
                row.querySelector('.batch-no').value = data.last_batch_no || '';
                row.querySelector('.expiry').value = data.last_expiry || '';
                row.querySelector('.mrp').value = data.product_MRP || '';
                row.querySelector('.return-rate').value = data.last_purchase_rate || '';
                
                // Clear stock info and validation when product changes
                const stockDiv = row.querySelector('.available-stock');
                const stockError = row.querySelector('.stock-error');
                const qtyInput = row.querySelector('.return-qty');
                
                if (stockDiv) stockDiv.textContent = '';
                if (stockError) stockError.style.display = 'none';
                if (qtyInput) {
                    qtyInput.style.borderColor = '';
                    qtyInput.style.backgroundColor = '';
                    qtyInput.style.boxShadow = '';
                    qtyInput.removeAttribute('data-stock-error');
                    qtyInput.removeAttribute('data-max-stock');
                }
                row.classList.remove('stock-error-row');
                
                // Unlock form if no other errors
                if (!document.querySelector('input[data-stock-error="true"]')) {
                    lockReturnFormInputs(false);
                }
                
                calculateReturnRowTotal(rowIndex);
            }
        })
        .catch(error => {
            console.error('Error fetching product info:', error);
        });
}
function collectReturnProductsData() {
    const products = [];
    const rows = document.querySelectorAll('#returnProductRows tr');
    
    rows.forEach((row, index) => {
        const productSelect = row.querySelector('.product-select');
        const productId = productSelect ? productSelect.value : '';
        
        if (productId) {
            const batchNo = row.querySelector('.batch-no')?.value?.trim() || '';
            const expiry = row.querySelector('.expiry')?.value?.trim() || '';
            const mrp = row.querySelector('.mrp')?.value?.trim() || '0';
            const returnRate = row.querySelector('.return-rate')?.value?.trim() || '0';
            const returnQty = row.querySelector('.return-qty')?.value?.trim() || '0';
            const scheme = row.querySelector('.scheme')?.value?.trim() || '0';
            const charges = row.querySelector('.charges')?.value?.trim() || '0';
            const reason = row.querySelector('.reason')?.value?.trim() || '';
            
            const product = {
                productid: productId,
                batch_no: batchNo,
                expiry: expiry,
                mrp: mrp,
                return_rate: returnRate,
                return_quantity: returnQty,
                scheme: scheme,
                charges: charges,
                reason: reason
            };
            
            products.push(product);
        }
    });
    
    return products;
}

function validateReturnForm() {
    const errors = [];
    
    const supplierId = document.querySelector('select[name*="returnsupplierid"]')?.value;
    if (!supplierId) {
        errors.push('Supplier selection is required');
    }
    
    const returnDate = document.querySelector('input[name*="returninvoice_date"]')?.value?.trim();
    if (!returnDate) {
        errors.push('Return date is required');
    }
    
    const returnTotal = document.querySelector('input[name*="returninvoice_total"]')?.value?.trim();
    if (!returnTotal || parseFloat(returnTotal) <= 0) {
        errors.push('Return total must be greater than 0');
    }
    
    return errors;
}

document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        addReturnProductRow();
        setTimeout(() => {
            const newRow = document.querySelector(`#returnProductRow_${returnProductRowIndex - 1}`);
            if (newRow) {
                newRow.querySelector('.product-select').focus();
            }
        }, 100);
    }
    
    if (e.ctrlKey && e.key.toLowerCase() === 's') {
        e.preventDefault();
        if (window.returnFormLocked) {
            alert('Cannot save! Please fix return stock quantity errors first.');
            // Focus on first stock error input
            const firstError = document.querySelector('input[data-stock-error="true"]');
            if (firstError) {
                firstError.focus();
                firstError.select();
            }
            return;
        }
        const form = document.getElementById('purchaseReturnForm');
        if (form) {
            form.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
        }
    }
    
    if (e.key === 'F2') {
        e.preventDefault();
        openQuickProductSearch();
    }
    
    if (e.altKey && e.key.toLowerCase() === 'w') {
        e.preventDefault();
        const focusedElement = document.activeElement;
        
        if (focusedElement && focusedElement.classList.contains('batch-no')) {
            const row = focusedElement.closest('tr');
            const productSelect = row.querySelector('.product-select');
            const rowIndex = row.id.split('_')[1];
            
            if (productSelect && productSelect.value) {
                showReturnBatchSelector(productSelect.value, rowIndex);
            } else {
                alert('Please select a product first!');
            }
        }
    }
});
function openQuickProductSearch() {
    const existingModal = document.getElementById('quickProductModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    const modalHTML = `
        <div id="quickProductModal" class="quick-search-overlay">
            <div class="quick-search-content">
                <div class="quick-search-header">
                    <h4>🔍 Quick Product Search</h4>
                    <small>Type product name and press Enter</small>
                </div>
                <div class="quick-search-input">
                    <input type="text" id="quickProductInput" placeholder="Type product name..." onkeyup="quickSearchProducts(event)">
                </div>
                <div class="quick-search-results" id="quickResults"></div>
                <div class="quick-search-footer">
                    <small>↑↓: Navigate | Enter: Select | Esc: Close</small>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    setTimeout(() => {
        const input = document.getElementById('quickProductInput');
        input.focus();
        
        input.addEventListener('keydown', function(e) {
            const resultsDiv = document.getElementById('quickResults');
            
            switch(e.key) {
                case 'Escape':
                    closeQuickSearch();
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    navigateResults(1);
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    navigateResults(-1);
                    break;
                case 'Enter':
                    e.preventDefault();
                    const selected = resultsDiv.querySelector('.selected') || resultsDiv.querySelector('.quick-result-item');
                    if (selected) {
                        const productName = selected.querySelector('.product-name').textContent;
                        const productCompany = selected.querySelector('.product-company').textContent;
                        
                        const products = [{% for product in products %}{
                            id: {{ product.productid }},
                            name: '{{ product.product_name|escapejs }}',
                            company: '{{ product.product_company|escapejs }}'
                        },{% endfor %}];
                        
                        const matchedProduct = products.find(p => 
                            p.name === productName && p.company === productCompany
                        );
                        
                        if (matchedProduct) {
                            quickSelectReturnProduct(matchedProduct.id, matchedProduct.name, matchedProduct.company);
                        }
                    }
                    break;
            }
        });
    }, 100);
}
function quickSearchProducts(event) {
    const originalSearchTerm = event.target.value;
    const searchTerm = originalSearchTerm.toLowerCase();
    const resultsDiv = document.getElementById('quickResults');
    
    if (['ArrowDown', 'ArrowUp', 'Enter', 'Escape'].includes(event.key)) {
        return;
    }
    
    if (originalSearchTerm.length < 2) {
        resultsDiv.innerHTML = '<div class="quick-hint">Type at least 2 characters...</div>';
        return;
    }
    
    const products = [{% for product in products %}{
        id: {{ product.productid }},
        name: '{{ product.product_name|escapejs }}',
        company: '{{ product.product_company|escapejs }}'
    },{% endfor %}];
    
    // Filter products that START with the search term (first 2+ letters)
    const filtered = products.filter(p => {
        // Primary filter: starts with search term (case-sensitive first, then case-insensitive)
        const exactStartsName = p.name.startsWith(originalSearchTerm);
        const exactStartsCompany = p.company.startsWith(originalSearchTerm);
        const startsName = p.name.toLowerCase().startsWith(searchTerm);
        const startsCompany = p.company.toLowerCase().startsWith(searchTerm);
        
        return exactStartsName || exactStartsCompany || startsName || startsCompany;
    }).sort((a, b) => {
        // Priority scoring for "starts with" matches
        let aScore = 0;
        let bScore = 0;
        
        // Exact case "starts with" gets highest priority (100 points)
        if (a.name.startsWith(originalSearchTerm)) aScore += 100;
        if (a.company.startsWith(originalSearchTerm)) aScore += 90;
        if (b.name.startsWith(originalSearchTerm)) bScore += 100;
        if (b.company.startsWith(originalSearchTerm)) bScore += 90;
        
        // Case-insensitive "starts with" gets medium priority (50 points)
        if (a.name.toLowerCase().startsWith(searchTerm)) aScore += 50;
        if (a.company.toLowerCase().startsWith(searchTerm)) aScore += 40;
        if (b.name.toLowerCase().startsWith(searchTerm)) bScore += 50;
        if (b.company.toLowerCase().startsWith(searchTerm)) bScore += 40;
        
        // Sort by score (higher score first)
        if (aScore !== bScore) {
            return bScore - aScore;
        }
        
        // If scores are equal, sort alphabetically
        return a.name.localeCompare(b.name);
    });
    
    if (filtered.length === 0) {
        resultsDiv.innerHTML = '<div class="no-results">No products starting with "' + originalSearchTerm + '" found</div>';
        return;
    }
    
    resultsDiv.innerHTML = filtered.map((product, index) => `
        <div class="quick-result-item ${index === 0 ? 'selected' : ''}" 
             onclick="quickSelectReturnProduct(${product.id}, '${product.name}', '${product.company}')">
            <div class="product-name">${product.name}</div>
            <div class="product-company">${product.company}</div>
        </div>
    `).join('');
}

function navigateResults(direction) {
    const items = document.querySelectorAll('.quick-result-item');
    if (items.length === 0) return;
    
    const current = document.querySelector('.quick-result-item.selected');
    let newIndex = 0;
    
    if (current) {
        const currentIndex = Array.from(items).indexOf(current);
        newIndex = currentIndex + direction;
        
        if (newIndex < 0) newIndex = items.length - 1;
        else if (newIndex >= items.length) newIndex = 0;
        
        current.classList.remove('selected');
    }
    
    items[newIndex].classList.add('selected');
    items[newIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function quickSelectReturnProduct(productId, productName, productCompany) {
    const rows = document.querySelectorAll('#returnProductRows tr');
    let targetRow = null;
    
    for (let row of rows) {
        const productSelect = row.querySelector('.product-select');
        if (productSelect && !productSelect.value) {
            targetRow = row;
            break;
        }
    }
    
    if (!targetRow) {
        addReturnProductRow();
        setTimeout(() => {
            const newRows = document.querySelectorAll('#returnProductRows tr');
            targetRow = newRows[newRows.length - 1];
            fillReturnProductInRow(targetRow, productId);
        }, 100);
    } else {
        fillReturnProductInRow(targetRow, productId);
    }
    
    closeQuickSearch();
}
function fillReturnProductInRow(row, productId) {
    const productSelect = row.querySelector('.product-select');
    if (productSelect) {
        productSelect.value = productId;
        
        const rowIndex = row.id.split('_')[1];
        loadReturnProductInfo(rowIndex, productId);
        
        setTimeout(() => {
            const batchField = row.querySelector('.batch-no');
            if (batchField) {
                batchField.focus();
                batchField.select();
            }
        }, 500);
    }
}

function closeQuickSearch() {
    const modal = document.getElementById('quickProductModal');
    if (modal) {
        modal.remove();
    }
}

function showReturnBatchSelector(productId, rowIndex) {
    fetch(`/api/product-batch-selector/?product_id=${productId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.batches.length > 0) {
                createReturnBatchModal(data.batches, rowIndex);
            } else {
                alert('No batches found for this product.');
            }
        })
        .catch(error => {
            console.error('Error fetching batches:', error);
            alert('Error loading batch information.');
        });
}

function createReturnBatchModal(batches, rowIndex) {
    const existingModal = document.getElementById('batchSelectionModal');
    if (existingModal) existingModal.remove();
    
    const modalHTML = `
        <div id="batchSelectionModal" class="batch-modal-overlay">
            <div class="batch-modal-content">
                <div class="batch-modal-header">
                    <h3>Select Batch</h3>
                    <button type="button" class="batch-modal-close" onclick="closeBatchModal()">&times;</button>
                </div>
                <div class="batch-modal-body">
                    <div class="batch-search">
                        <input type="text" id="batchSearch" placeholder="Search batch..." onkeyup="filterBatches()">
                    </div>
                    <div class="batch-list" id="batchList">
                        ${batches.map(batch => `
                            <div class="batch-item" onclick="selectReturnBatch('${batch.batch_no}', ${rowIndex}, ${JSON.stringify(batch).replace(/"/g, '&quot;')})">
                                <div class="batch-info">
                                    <div class="batch-no"><strong>${batch.batch_no}</strong></div>
                                    <div class="batch-details">
                                        <span>Exp: ${batch.expiry}</span>
                                        <span>Stock: ${batch.stock}</span>
                                        <span>MRP: ₹${batch.mrp}</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="batch-modal-footer">
                    <div class="batch-shortcuts">
                        <small>↑↓: Navigate | Enter: Select | Esc: Close</small>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="closeBatchModal()">Cancel</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    setTimeout(() => {
        const searchInput = document.getElementById('batchSearch');
        searchInput.focus();
        
        const firstBatch = document.querySelector('.batch-item');
        if (firstBatch) firstBatch.classList.add('batch-selected');
        
        searchInput.addEventListener('keydown', function(e) {
            const visibleItems = document.querySelectorAll('.batch-item:not([style*="display: none"])');
            let selectedIndex = Array.from(visibleItems).findIndex(item => item.classList.contains('batch-selected'));
            
            switch(e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    if (selectedIndex < visibleItems.length - 1) {
                        if (selectedIndex >= 0) visibleItems[selectedIndex].classList.remove('batch-selected');
                        selectedIndex++;
                        visibleItems[selectedIndex].classList.add('batch-selected');
                        visibleItems[selectedIndex].scrollIntoView({ block: 'nearest' });
                    }
                    break;
                    
                case 'ArrowUp':
                    e.preventDefault();
                    if (selectedIndex > 0) {
                        visibleItems[selectedIndex].classList.remove('batch-selected');
                        selectedIndex--;
                        visibleItems[selectedIndex].classList.add('batch-selected');
                        visibleItems[selectedIndex].scrollIntoView({ block: 'nearest' });
                    }
                    break;
                    
                case 'Enter':
                    e.preventDefault();
                    if (selectedIndex >= 0 && visibleItems[selectedIndex]) {
                        visibleItems[selectedIndex].click();
                    }
                    break;
                    
                case 'Escape':
                    e.preventDefault();
                    closeBatchModal();
                    break;
            }
        });
    }, 100);
}

function selectReturnBatch(batchNo, rowIndex, batchData) {
    const row = document.getElementById(`returnProductRow_${rowIndex}`);
    if (row) {
        row.querySelector('.batch-no').value = batchNo;
        row.querySelector('.expiry').value = batchData.expiry;
        row.querySelector('.mrp').value = batchData.mrp;
        row.querySelector('.return-rate').value = batchData.purchase_rate || batchData.mrp;
        
        // Show available stock
        const stockDiv = row.querySelector('.available-stock');
        if (stockDiv) {
            stockDiv.textContent = `Available: ${batchData.stock} units`;
            stockDiv.style.color = batchData.stock > 0 ? '#059669' : '#dc2626';
        }
        
        calculateReturnRowTotal(rowIndex);
        
        // Auto-focus on return quantity field and validate stock
        setTimeout(() => {
            const qtyField = row.querySelector('.return-qty');
            if (qtyField) {
                qtyField.focus();
                qtyField.select();
                // Trigger stock validation if there's already a value
                if (qtyField.value) {
                    validateReturnStockAndCalculate(rowIndex);
                }
            }
        }, 100);
    }
    closeBatchModal();
}

function closeBatchModal() {
    const modal = document.getElementById('batchSelectionModal');
    if (modal) modal.remove();
}

function filterBatches() {
    const searchTerm = document.getElementById('batchSearch').value.toLowerCase();
    const batchItems = document.querySelectorAll('.batch-item');
    
    batchItems.forEach(item => {
        const batchNo = item.querySelector('.batch-no').textContent.toLowerCase();
        if (batchNo.includes(searchTerm)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

// Setup quantity validation for return form
function setupReturnQuantityValidation() {
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('return-qty')) {
            const input = e.target;
            const row = input.closest('tr');
            const rowIndex = row.id.split('_')[1];
            
            console.log(`📝 Return quantity changed in row ${rowIndex}: ${input.value}`);
            
            // Immediate validation for better UX
            clearTimeout(input.validationTimeout);
            input.validationTimeout = setTimeout(() => {
                validateReturnStockAndCalculate(rowIndex);
            }, 100);
        }
    });
    
    // Also validate on change and blur events
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('return-qty')) {
            const input = e.target;
            const row = input.closest('tr');
            const rowIndex = row.id.split('_')[1];
            validateReturnStockAndCalculate(rowIndex);
        }
    });
    
    document.addEventListener('blur', function(e) {
        if (e.target.classList.contains('return-qty')) {
            const input = e.target;
            const row = input.closest('tr');
            const rowIndex = row.id.split('_')[1];
            validateReturnStockAndCalculate(rowIndex);
        }
    });
    
    // Prevent invalid characters in return quantity inputs
    document.addEventListener('keydown', function(e) {
        if (e.target.classList.contains('return-qty')) {
            const allowedKeys = ['Backspace', 'Delete', 'Tab', 'Escape', 'Enter', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'];
            const isNumber = /[0-9]/.test(e.key);
            const isDecimal = e.key === '.' && !e.target.value.includes('.');
            
            if (!allowedKeys.includes(e.key) && !isNumber && !isDecimal && !(e.ctrlKey || e.metaKey)) {
                e.preventDefault();
            }
        }
    });
    
    // Paste validation for return quantity inputs
    document.addEventListener('paste', function(e) {
        if (e.target.classList.contains('return-qty')) {
            setTimeout(() => {
                const value = e.target.value;
                if (!/^\d*\.?\d*$/.test(value)) {
                    e.target.value = value.replace(/[^0-9.]/g, '');
                }
                
                const row = e.target.closest('tr');
                const rowIndex = row.id.split('_')[1];
                validateReturnStockAndCalculate(rowIndex);
            }, 10);
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    setCurrentReturnDate();
    
    // Setup enhanced quantity validation
    setupReturnQuantityValidation();
    
    // Enhanced focus on supplier dropdown first
    function focusSupplierSelect() {
        const supplierSelect = document.querySelector('select[name*="returnsupplierid"]') ||
                              document.querySelector('#id_returnsupplierid');
        
        if (supplierSelect) {
            supplierSelect.focus();
            console.log('✓ Purchase return supplier field focused:', supplierSelect.name);
            return true;
        } else {
            console.error('❌ Purchase return supplier field not found');
            return false;
        }
    }
    
    // Try multiple times with increasing delays
    setTimeout(focusSupplierSelect, 100);
    setTimeout(focusSupplierSelect, 300);
    setTimeout(focusSupplierSelect, 500);
    
    const returnChargesInput = document.querySelector('input[name*="return_charges"]');
    if (returnChargesInput) {
        returnChargesInput.addEventListener('input', calculateReturnTotal);
    }
    
    // Handle return date input with DDMMYYYY format
    const returnDateInput = document.querySelector('input[name*="returninvoice_date"]');
    if (returnDateInput) {
        returnDateInput.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key.toLowerCase() === 't') {
                e.preventDefault();
                setCurrentReturnDate();
                return;
            }
        });
        
        returnDateInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const inputs = Array.from(document.querySelectorAll('input, select'));
                const currentIndex = inputs.indexOf(this);
                if (currentIndex < inputs.length - 1) {
                    inputs[currentIndex + 1].focus();
                }
            }
        });
    }
    
    const form = document.getElementById('purchaseReturnForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Check for stock validation errors first
            const stockErrors = document.querySelectorAll('input[data-stock-error="true"]');
            if (stockErrors.length > 0) {
                const errorCount = stockErrors.length;
                const errorDetails = Array.from(stockErrors).map((input, index) => {
                    const row = input.closest('tr');
                    const productName = row.querySelector('.product-select option:checked')?.textContent || 'Unknown Product';
                    const maxStock = input.getAttribute('data-max-stock') || '0';
                    const currentQty = input.value || '0';
                    return `${index + 1}. ${productName}: Entered ${currentQty}, Available ${maxStock}`;
                }).join('\n');
                
                alert(`Cannot save return! Found ${errorCount} stock validation error(s):\n\n${errorDetails}\n\nPlease correct these quantities before saving.`);
                
                // Focus on first error and highlight all error rows
                stockErrors[0].focus();
                stockErrors[0].select();
                
                // Highlight all error rows
                stockErrors.forEach(input => {
                    const row = input.closest('tr');
                    row.style.backgroundColor = '#f8d7da';
                    row.style.border = '2px solid #dc3545';
                    setTimeout(() => {
                        row.style.backgroundColor = '';
                        row.style.border = '';
                    }, 3000);
                });
                
                return false;
            }
            
            const formErrors = validateReturnForm();
            if (formErrors.length > 0) {
                alert('Please fix the following errors:\\n\\n' + formErrors.join('\\n'));
                return false;
            }
            
            const productsData = collectReturnProductsData();
            
            if (productsData.length === 0) {
                alert('Please add at least one product to the return.');
                return false;
            }
            
            // Additional validation: Check if any quantity exceeds available stock
            let hasStockIssues = false;
            const rows = document.querySelectorAll('#returnProductRows tr');
            
            rows.forEach((row, index) => {
                const quantityInput = row.querySelector('.return-qty');
                const stockInfo = row.querySelector('.available-stock');
                
                if (quantityInput && quantityInput.value && stockInfo) {
                    const quantity = parseFloat(quantityInput.value) || 0;
                    const stockMatch = stockInfo.textContent.match(/Available: (\d+(?:\.\d+)?)/i);
                    
                    if (stockMatch) {
                        const availableStock = parseFloat(stockMatch[1]);
                        if (availableStock > 0 && quantity > availableStock) {
                            hasStockIssues = true;
                            quantityInput.style.borderColor = '#dc3545';
                            quantityInput.style.backgroundColor = '#f8d7da';
                        }
                    }
                }
            });
            
            if (hasStockIssues) {
                alert('Return stock validation failed! Some quantities exceed available stock. Please review and correct.');
                return false;
            }
            
            let hasErrors = false;
            let errorMessages = [];
            
            // Validate all required fields
            rows.forEach((row, index) => {
                const requiredFields = row.querySelectorAll('input[required], select[required]');
                requiredFields.forEach(field => {
                    if (!field.value.trim()) {
                        field.classList.add('is-invalid');
                        hasErrors = true;
                    } else {
                        field.classList.remove('is-invalid');
                    }
                });
            });
            
            if (hasErrors) {
                alert('Please fill all required fields for all products.');
                return false;
            }
            
            productsData.forEach((product, index) => {
                const rowNum = index + 1;
                
                if (!product.batch_no) {
                    errorMessages.push(`Row ${rowNum}: Batch number is required`);
                    hasErrors = true;
                }
                if (!product.expiry) {
                    errorMessages.push(`Row ${rowNum}: Expiry date is required`);
                    hasErrors = true;
                }
                if (!product.return_quantity || parseFloat(product.return_quantity) <= 0) {
                    errorMessages.push(`Row ${rowNum}: Return quantity must be greater than 0`);
                    hasErrors = true;
                }
                if (!product.return_rate || parseFloat(product.return_rate) <= 0) {
                    errorMessages.push(`Row ${rowNum}: Return rate must be greater than 0`);
                    hasErrors = true;
                }
            });
            
            if (hasErrors) {
                alert('Please fix the following errors:\\n\\n' + errorMessages.slice(0, 5).join('\\n'));
                return false;
            }
            
            document.getElementById('returnProductsData').value = JSON.stringify(productsData);
            
            // Validate return date format (DDMMYYYY)
            const returnDateInput = document.querySelector('input[name*="returninvoice_date"]');
            if (returnDateInput && returnDateInput.value) {
                const dateValue = returnDateInput.value.trim();
                
                // Check if it's in DDMMYYYY format
                if (dateValue.length === 8 && /^\d{8}$/.test(dateValue)) {
                    // Validate the date
                    const day = parseInt(dateValue.substring(0, 2));
                    const month = parseInt(dateValue.substring(2, 4));
                    const year = parseInt(dateValue.substring(4, 8));
                    
                    if (month < 1 || month > 12 || day < 1 || day > 31 || year < 1900 || year > 2100) {
                        alert('Please enter a valid return date in DDMMYYYY format.');
                        returnDateInput.focus();
                        return false;
                    }
                    
                    // Check for valid day in month
                    const daysInMonth = new Date(year, month, 0).getDate();
                    if (day > daysInMonth) {
                        alert('Please enter a valid return date in DDMMYYYY format.');
                        returnDateInput.focus();
                        return false;
                    }
                } else {
                    alert('Please enter return date in DDMMYYYY format (8 digits).');
                    returnDateInput.focus();
                    return false;
                }
            }
            
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            }
            
            form.submit();
        });
    }
});
</script>
{% endblock %}

<style>
/* Quick Search Modal Styles */
.quick-search-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.quick-search-content {
    background: white;
    border-radius: 10px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.quick-search-header {
    background: #059669;
    color: white;
    padding: 20px;
    text-align: center;
}

.quick-search-header h4 {
    margin: 0 0 5px 0;
    font-size: 1.2rem;
}

.quick-search-input {
    padding: 20px;
}

.quick-search-input input {
    width: 100%;
    padding: 12px;
    border: 2px solid #e5e7eb;
    border-radius: 6px;
    font-size: 1rem;
    outline: none;
}

.quick-search-input input:focus {
    border-color: #059669;
    box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
}

.quick-search-results {
    max-height: 300px;
    overflow-y: auto;
    padding: 0 20px;
}

.quick-result-item {
    padding: 12px;
    border-bottom: 1px solid #e5e7eb;
    cursor: pointer;
    transition: background-color 0.2s;
}

.quick-result-item:hover,
.quick-result-item.selected {
    background: #f0fdf4;
}

.product-name {
    font-weight: 600;
    color: #374151;
}

.product-company {
    font-size: 0.9rem;
    color: #6b7280;
    margin-top: 2px;
}

.quick-hint,
.no-results {
    text-align: center;
    padding: 20px;
    color: #6b7280;
    font-style: italic;
}

.quick-search-footer {
    background: #f9fafb;
    padding: 15px 20px;
    text-align: center;
    border-top: 1px solid #e5e7eb;
}

/* Batch Selection Modal Styles */
.batch-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.batch-modal-content {
    background: white;
    border-radius: 10px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.batch-modal-header {
    background: #059669;
    color: white;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.batch-modal-header h3 {
    margin: 0;
    font-size: 1.2rem;
}

.batch-modal-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.batch-modal-body {
    padding: 20px;
}

.batch-search input {
    width: 100%;
    padding: 10px;
    border: 2px solid #e5e7eb;
    border-radius: 6px;
    margin-bottom: 15px;
    outline: none;
}

.batch-search input:focus {
    border-color: #059669;
    box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
}

.batch-list {
    max-height: 300px;
    overflow-y: auto;
}

.batch-item {
    padding: 12px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s;
}

.batch-item:hover,
.batch-item.batch-selected {
    background: #f0fdf4;
    border-color: #059669;
}

.batch-no {
    font-size: 1rem;
    margin-bottom: 5px;
}

.batch-details {
    display: flex;
    gap: 15px;
    font-size: 0.9rem;
    color: #6b7280;
}

.batch-modal-footer {
    background: #f9fafb;
    padding: 15px 20px;
    border-top: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.batch-shortcuts {
    font-size: 0.8rem;
    color: #6b7280;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
}

.btn-secondary {
    background: #6b7280;
    color: white;
}

.btn-secondary:hover {
    background: #4b5563;
}

/* Available stock info styling */
.available-stock {
    display: block;
    margin-top: 4px;
    padding: 4px 8px;
    background: rgba(5, 150, 105, 0.1);
    border-radius: 4px;
    border-left: 3px solid #059669;
}

/* Keyboard Shortcuts Footer */
.pr-shortcuts-footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #1f2937;
    color: #d1d5db;
    padding: 10px 20px;
    font-size: 0.8rem;
    display: flex;
    justify-content: center;
    gap: 30px;
    z-index: 100;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
}

.pr-shortcut-item {
    display: flex;
    align-items: center;
    gap: 5px;
}

.pr-shortcut-key {
    background: #374151;
    padding: 2px 6px;
    border-radius: 3px;
    font-weight: 600;
    font-size: 0.7rem;
}

/* Compact Form Styles */
.ci-main-container {
    padding: 10px;
    padding-bottom: 60px;
}

.ci-wrapper-card {
    margin: 0;
    padding: 15px;
}

.ci-page-header {
    margin-bottom: 15px;
    padding: 10px 0;
}

.ci-main-title {
    font-size: 1.1rem;
    margin: 0;
}

.ci-invoice-details-section {
    margin-bottom: 15px;
}

.ci-section-title {
    font-size: 1rem;
    margin-bottom: 10px;
}

.return-id-preview {
    background: #f8f9fa;
    padding: 8px 12px;
    border-radius: 4px;
    margin-bottom: 15px;
    font-size: 0.9rem;
}

.ci-form-row {
    margin-bottom: 15px;
}

.ci-field-group {
    margin-bottom: 10px;
}

.ci-field-label {
    font-size: 0.9rem;
    margin-bottom: 5px;
}

.ci-products-header {
    margin-bottom: 10px;
}

.ci-keyboard-shortcuts {
    font-size: 0.75rem;
}

.ci-products-table {
    font-size: 0.85rem;
}

.ci-products-table th,
.ci-products-table td {
    padding: 6px 8px;
}

.ci-products-table input,
.ci-products-table select {
    font-size: 0.8rem;
    padding: 4px 6px;
}

.ci-total-section {
    margin-top: 10px;
    margin-bottom: 15px;
}

.ci-form-actions {
    margin-top: 15px;
}

.ci-save-btn {
    padding: 8px 16px;
    font-size: 0.9rem;
}

/* Stock Validation Error Styles */
.stock-error-row {
    background-color: rgba(220, 53, 69, 0.1) !important;
    border-left: 4px solid #dc3545 !important;
}

.return-qty.stock-error {
    border-color: #dc3545 !important;
    background-color: #f8d7da !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
}

.stock-error {
    animation: errorPulse 1s ease-in-out infinite alternate;
}

@keyframes errorPulse {
    from { opacity: 1; }
    to { opacity: 0.7; }
}

/* Form lock overlay animation */
#returnStockErrorOverlay {
    animation: slideInFromTop 0.4s ease-out;
    transition: all 0.3s ease;
}

@keyframes slideInFromTop {
    from {
        opacity: 0;
        transform: translateX(-50%) translateY(-30px);
    }
    to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
}

/* Disabled input styling */
input[data-locked="true"], 
select[data-locked="true"], 
button[data-locked="true"] {
    cursor: not-allowed !important;
    filter: grayscale(50%) !important;
}

/* Enhanced return quantity input focus */
.return-qty:focus {
    border-color: #059669;
    box-shadow: 0 0 0 0.2rem rgba(5, 150, 105, 0.25);
}

.return-qty[data-stock-error="true"]:focus {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}

/* Button danger state */
.btn-danger {
    background-color: #dc3545;
    border-color: #dc3545;
    color: white;
}

.btn-danger:hover {
    background-color: #c82333;
    border-color: #bd2130;
}
</style>

<!-- Keyboard Shortcuts Footer -->
<div class="pr-shortcuts-footer">
    <div class="pr-shortcut-item">
        <span class="pr-shortcut-key">F2</span>
        <span>Quick Search</span>
    </div>
    <div class="pr-shortcut-item">
        <span class="pr-shortcut-key">Alt+W</span>
        <span>Batch Selector</span>
    </div>
    <div class="pr-shortcut-item">
        <span class="pr-shortcut-key">Ctrl+Enter</span>
        <span>Add Product</span>
    </div>
    <div class="pr-shortcut-item">
        <span class="pr-shortcut-key">Ctrl+S</span>
        <span>Save Return</span>
    </div>
    <div class="pr-shortcut-item">
        <span class="pr-shortcut-key">Esc</span>
        <span>Close Modal</span>
    </div>
</div>