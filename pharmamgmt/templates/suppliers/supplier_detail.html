{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/supplier_detail.css' %}">
{% endblock %}

{% block page_actions %}
<div class="supplier-detail-actions">
    {% if request.user.user_type == 'admin' %}
    <a href="{% url 'delete_supplier' pk=supplier.supplierid %}" class="supplier-detail-delete-btn">
        <i class="fas fa-trash me-2 supplier-detail-delete-icon"></i>Delete Supplier
    </a>
    {% endif %}
    <a href="{% url 'supplier_list' %}" class="supplier-detail-back-btn">
        <i class="fas fa-arrow-left me-2 supplier-detail-back-icon"></i>Back to Suppliers
    </a>
</div>
{% endblock %}

{% block content %}
<div class="supplier-detail-container">
    <div class="supplier-detail-wrapper">
        <div class="supplier-detail-info-card">
            <div class="supplier-detail-card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h5 class="supplier-detail-card-title">Supplier Information</h5>
                <button type="button" class="supplier-detail-edit-btn" onclick="openEditSupplierModal()" style="font-size: 0.8rem; padding: 6px 12px;">
                    <i class="fas fa-edit me-1 supplier-detail-edit-icon"></i>Edit
                </button>
            </div>
            <div class="supplier-detail-card-body">
                <h4 class="supplier-detail-name">{{ supplier.supplier_name }}</h4>
                <p class="supplier-detail-type">{{ supplier.supplier_type }}</p>
                
                <ul class="supplier-detail-info-list">
                    <li class="supplier-detail-info-item">
                        <span class="supplier-detail-info-label"><i class="fas fa-id-card me-2 supplier-detail-id-icon"></i>Supplier ID</span>
                        <span class="supplier-detail-info-value">{{ supplier.supplierid }}</span>
                    </li>
                    <li class="supplier-detail-info-item">
                        <i class="fas fa-map-marker-alt me-2 supplier-detail-address-icon"></i><strong class="supplier-detail-info-strong">Address:</strong>
                        <div class="supplier-detail-address">{{ supplier.supplier_address }}</div>
                    </li>
                    <li class="supplier-detail-info-item">
                        <i class="fas fa-phone me-2 supplier-detail-phone-icon"></i><strong class="supplier-detail-info-strong">Mobile:</strong> {{ supplier.supplier_mobile }}
                    </li>
                    <li class="supplier-detail-info-item">
                        <i class="fab fa-whatsapp me-2 supplier-detail-whatsapp-icon"></i><strong class="supplier-detail-info-strong">WhatsApp:</strong> {{ supplier.supplier_whatsapp }}
                    </li>
                    <li class="supplier-detail-info-item">
                        <i class="fas fa-envelope me-2 supplier-detail-email-icon"></i><strong class="supplier-detail-info-strong">Email:</strong> {{ supplier.supplier_emailid }}
                    </li>
                    <li class="supplier-detail-info-item">
                        <i class="fas fa-user me-2 supplier-detail-contact-icon"></i><strong class="supplier-detail-info-strong">Contact Person:</strong> {{ supplier.supplier_spoc }}
                    </li>
                </ul>
            </div>
        </div>
        
        <div class="supplier-detail-legal-card">
            <div class="supplier-detail-card-header">
                <h5 class="supplier-detail-card-title">Legal Information</h5>
            </div>
            <div class="supplier-detail-card-body">
                <ul class="supplier-detail-legal-list">
                    <li class="supplier-detail-legal-item">
                        <i class="fas fa-certificate me-2 supplier-detail-license-icon"></i><strong class="supplier-detail-info-strong">Drug License:</strong> {{ supplier.supplier_dlno }}
                    </li>
                    <li class="supplier-detail-legal-item">
                        <i class="fas fa-file-invoice me-2 supplier-detail-gst-icon"></i><strong class="supplier-detail-info-strong">GST Number:</strong> {{ supplier.supplier_gstno }}
                    </li>
                </ul>
            </div>
        </div>
        
        <div class="supplier-detail-bank-card">
            <div class="supplier-detail-card-header">
                <h5 class="supplier-detail-card-title">Bank Details</h5>
            </div>
            <div class="supplier-detail-card-body">
                <ul class="supplier-detail-bank-list">
                    <li class="supplier-detail-bank-item">
                        <i class="fas fa-university me-2 supplier-detail-bank-icon"></i><strong class="supplier-detail-info-strong">Bank Name:</strong> {{ supplier.supplier_bank }}
                    </li>
                    <li class="supplier-detail-bank-item">
                        <i class="fas fa-credit-card me-2 supplier-detail-account-icon"></i><strong class="supplier-detail-info-strong">Account Number:</strong> {{ supplier.supplier_bankaccountno }}
                    </li>
                    <li class="supplier-detail-bank-item">
                        <i class="fas fa-code me-2 supplier-detail-ifsc-icon"></i><strong class="supplier-detail-info-strong">IFSC Code:</strong> {{ supplier.supplier_bankifsc }}
                    </li>
                    {% if supplier.supplier_upi %}
                    <li class="supplier-detail-bank-item">
                        <i class="fas fa-mobile-alt me-2 supplier-detail-upi-icon"></i><strong class="supplier-detail-info-strong">UPI ID:</strong> {{ supplier.supplier_upi }}
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
    
    <div class="supplier-detail-right-section">
        <div class="supplier-detail-financial-card">
            <div class="supplier-detail-card-header">
                <h5 class="supplier-detail-card-title">Financial Summary</h5>
            </div>
            <div class="supplier-detail-card-body">
                <div class="supplier-detail-financial-stats">
                    <div class="supplier-detail-stat-item">
                        <h6 class="supplier-detail-stat-label">Total Purchase</h6>
                        <h3 class="supplier-detail-stat-value supplier-detail-total-purchase">{{ total_purchase|currency }}</h3>
                    </div>
                    <div class="supplier-detail-stat-item">
                        <h6 class="supplier-detail-stat-label">Total Paid</h6>
                        <h3 class="supplier-detail-stat-value supplier-detail-total-paid">{{ total_paid|currency }}</h3>
                    </div>
                    <div class="supplier-detail-stat-item">
                        <h6 class="supplier-detail-stat-label">Outstanding Balance</h6>
                        <h3 class="supplier-detail-stat-value supplier-detail-balance">
                            {{ balance|currency }}
                        </h3>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="supplier-detail-history-card">
            <div class="supplier-detail-card-header supplier-detail-history-header">
                <h5 class="supplier-detail-card-title">Purchase History</h5>
                <a href="{% url 'add_invoice_with_products' %}" class="supplier-detail-new-invoice-btn">
                    <i class="fas fa-plus me-1 supplier-detail-plus-icon"></i> New Invoice
                </a>
            </div>
            <div class="supplier-detail-card-body">
                <div class="supplier-detail-table-wrapper">
                    <table class="supplier-detail-history-table">
                        <thead class="supplier-detail-table-head">
                            <tr class="supplier-detail-table-header-row">
                                <th class="supplier-detail-table-th supplier-detail-th-invoice">Invoice #</th>
                                <th class="supplier-detail-table-th supplier-detail-th-date">Date</th>
                                <th class="supplier-detail-table-th supplier-detail-th-amount">Amount</th>
                                <th class="supplier-detail-table-th supplier-detail-th-paid">Paid</th>
                                <th class="supplier-detail-table-th supplier-detail-th-balance">Balance</th>
                                <th class="supplier-detail-table-th supplier-detail-th-actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="supplier-detail-table-body">
                            {% for invoice in invoices %}
                            <tr class="supplier-detail-table-row">
                                <td class="supplier-detail-table-td supplier-detail-td-invoice">{{ invoice.invoice_no }}</td>
                                <td class="supplier-detail-table-td supplier-detail-td-date">{{ invoice.invoice_date }}</td>
                                <td class="supplier-detail-table-td supplier-detail-td-amount">{{ invoice.invoice_total|currency }}</td>
                                <td class="supplier-detail-table-td supplier-detail-td-paid">{{ invoice.invoice_paid|currency }}</td>
                                <td class="supplier-detail-table-td supplier-detail-td-balance {% if invoice.balance_due > 0 %}text-danger{% else %}text-success{% endif %}">
                                    {{ invoice.balance_due|currency }}
                                </td>
                                <td class="supplier-detail-table-td supplier-detail-td-actions">
                                    <a href="{% url 'invoice_detail' pk=invoice.invoiceid %}" class="supplier-detail-action-btn supplier-detail-view-btn">
                                        <i class="fas fa-eye supplier-detail-view-icon"></i>
                                    </a>
                                    {% if invoice.balance_due > 0 %}
                                    <a href="{% url 'add_invoice_payment' invoice_id=invoice.invoiceid %}" class="supplier-detail-action-btn supplier-detail-payment-btn">
                                        <i class="fas fa-money-bill-wave supplier-detail-payment-icon"></i>
                                    </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr class="supplier-detail-empty-row">
                                <td colspan="6" class="supplier-detail-empty-message">No invoices found for this supplier.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Supplier Modal -->
<div id="editSupplierModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Supplier</h3>
            <button type="button" class="modal-close" onclick="closeEditSupplierModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editSupplierForm">
                {% csrf_token %}
                <div class="form-row">
                    <div class="form-group">
                        <label>Supplier Name*</label>
                        <input type="text" name="supplier_name" value="{{ supplier.supplier_name }}" required>
                    </div>
                    <div class="form-group">
                        <label>Supplier Type</label>
                        <input type="text" name="supplier_type" value="{{ supplier.supplier_type }}">
                    </div>
                    <div class="form-group">
                        <label>Mobile*</label>
                        <input type="text" name="supplier_mobile" value="{{ supplier.supplier_mobile }}" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>WhatsApp</label>
                        <input type="text" name="supplier_whatsapp" value="{{ supplier.supplier_whatsapp }}">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" name="supplier_emailid" value="{{ supplier.supplier_emailid }}">
                    </div>
                    <div class="form-group">
                        <label>Contact Person</label>
                        <input type="text" name="supplier_spoc" value="{{ supplier.supplier_spoc }}">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group full-width">
                        <label>Address</label>
                        <textarea name="supplier_address" rows="2">{{ supplier.supplier_address }}</textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Drug License No</label>
                        <input type="text" name="supplier_dlno" value="{{ supplier.supplier_dlno }}">
                    </div>
                    <div class="form-group">
                        <label>GST Number</label>
                        <input type="text" name="supplier_gstno" value="{{ supplier.supplier_gstno }}">
                    </div>
                    <div class="form-group">
                        <label>Bank Name</label>
                        <input type="text" name="supplier_bank" value="{{ supplier.supplier_bank }}">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Account Number</label>
                        <input type="text" name="supplier_bankaccountno" value="{{ supplier.supplier_bankaccountno }}">
                    </div>
                    <div class="form-group">
                        <label>IFSC Code</label>
                        <input type="text" name="supplier_bankifsc" value="{{ supplier.supplier_bankifsc }}">
                    </div>
                    <div class="form-group">
                        <label>UPI ID</label>
                        <input type="text" name="supplier_upi" value="{{ supplier.supplier_upi }}">
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeEditSupplierModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="saveSupplier()">Save Changes</button>
        </div>
    </div>
</div>

<style>
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    border-radius: 6px;
    width: 95%;
    max-width: 800px;
    max-height: 85vh;
    overflow-y: auto;
}

.modal-header {
    padding: 12px 15px;
    border-bottom: 1px solid #e5e5e5;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-close {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
}

.modal-body {
    padding: 15px;
}

.modal-footer {
    padding: 12px 15px;
    border-top: 1px solid #e5e5e5;
    display: flex;
    justify-content: flex-end;
    gap: 8px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 12px;
    margin-bottom: 12px;
}

.form-group {
    margin-bottom: 0;
}

.form-group.full-width {
    grid-column: span 3;
}

.form-group.half-width {
    grid-column: span 2;
}

.form-group label {
    display: block;
    margin-bottom: 4px;
    font-weight: 600;
    font-size: 0.85rem;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 6px 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.9rem;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}
</style>

<script>
function openEditSupplierModal() {
    document.getElementById('editSupplierModal').style.display = 'flex';
    setTimeout(() => {
        const firstInput = document.querySelector('#editSupplierForm input[name="supplier_name"]');
        if (firstInput) {
            firstInput.focus();
            firstInput.select();
        }
    }, 100);
}

function closeEditSupplierModal() {
    document.getElementById('editSupplierModal').style.display = 'none';
}

function saveSupplier() {
    const form = document.getElementById('editSupplierForm');
    const formData = new FormData(form);
    
    fetch('{% url "update_supplier" pk=supplier.supplierid %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        if (response.ok) {
            alert('Supplier updated successfully!');
            location.reload();
        } else {
            alert('Error updating supplier');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating supplier');
    });
}

// Keyboard shortcut Ctrl+E for edit
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 'e') {
        e.preventDefault();
        openEditSupplierModal();
    }
});
</script>
{% endblock %}








