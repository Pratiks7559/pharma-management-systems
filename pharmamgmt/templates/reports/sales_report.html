{% extends 'base.html' %}
{% load custom_filters %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/sales_report.css' %}">
<style>
.analytics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin: 20px 0;
}
.analytics-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-left: 4px solid #007bff;
}
.analytics-card h3 {
    margin: 0 0 10px 0;
    color: #333;
    font-size: 14px;
    text-transform: uppercase;
}
.analytics-value {
    font-size: 24px;
    font-weight: bold;
    color: #007bff;
}
.analytics-subtitle {
    font-size: 12px;
    color: #666;
    margin-top: 5px;
}
.realtime-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    background: #28a745;
    border-radius: 50%;
    animation: pulse 2s infinite;
}
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}
.enhanced-table {
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.table-header {
    background: #f8f9fa;
    padding: 15px 20px;
    border-bottom: 1px solid #dee2e6;
}
.chart-container {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin: 20px 0;
}
</style>
{% endblock %}

{% block content %}
<div class="sales-report-container">
    <div class="sales-report-header">
        <h1 class="sales-report-title">
            <span class="realtime-indicator"></span>
            {{ title }}
        </h1>
        <div class="sales-export-buttons no-print">
            <a href="{% url 'export_sales_pdf' %}?start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}" class="sales-export-btn sales-export-pdf">
                <i class="fas fa-file-pdf"></i> PDF
            </a>
            <a href="{% url 'export_sales_excel' %}?start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}" class="sales-export-btn sales-export-excel">
                <i class="fas fa-file-csv"></i> CSV/Excel
            </a>
            <button onclick="window.print()" class="sales-export-btn sales-export-print">
                <i class="fas fa-print"></i> Print (Ctrl+P)
            </button>
            <button onclick="refreshData()" class="sales-export-btn" style="background: #28a745;">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Enhanced Date Range Selector -->
    <div class="enhanced-table">
        <div class="table-header">
            <h3><i class="fas fa-calendar-alt"></i> Select Analysis Period</h3>
        </div>
        <div style="padding: 20px;">
            <form method="get" class="sales-date-range-form">
                <div class="row">
                    <div class="col-md-3">
                        <label for="start_date" class="form-label">Start Date</label>
                        <input type="date" id="start_date" name="start_date" value="{{ start_date|date:'Y-m-d' }}" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label for="end_date" class="form-label">End Date</label>
                        <input type="date" id="end_date" name="end_date" value="{{ end_date|date:'Y-m-d' }}" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i> Analyze
                            </button>
                            <button type="button" onclick="setQuickRange('today')" class="btn btn-outline-secondary btn-sm">Today</button>
                            <button type="button" onclick="setQuickRange('week')" class="btn btn-outline-secondary btn-sm">This Week</button>
                            <button type="button" onclick="setQuickRange('month')" class="btn btn-outline-secondary btn-sm">This Month</button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Quick Actions</label>
                        <div>
                            <button type="button" onclick="exportReport('pdf')" class="btn btn-outline-danger btn-sm">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                            <button type="button" onclick="exportReport('excel')" class="btn btn-outline-success btn-sm">
                                <i class="fas fa-file-excel"></i> Excel
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Enhanced Analytics Dashboard -->
    <div class="analytics-grid">
        <div class="analytics-card">
            <h3><i class="fas fa-chart-line"></i> Total Sales</h3>
            <div class="analytics-value">₹ {{ total_sales|floatformat:2 }}</div>
            <div class="analytics-subtitle">{{ start_date|date:"M d, Y" }} - {{ end_date|date:"M d, Y" }}</div>
        </div>
        
        <div class="analytics-card">
            <h3><i class="fas fa-money-bill-wave"></i> Amount Received</h3>
            <div class="analytics-value">₹ {{ total_received|floatformat:2 }}</div>
            <div class="analytics-subtitle">Collection Rate: {{ payment_analysis.collection_rate|floatformat:1 }}%</div>
        </div>
        
        <div class="analytics-card">
            <h3><i class="fas fa-exclamation-triangle"></i> Amount Pending</h3>
            <div class="analytics-value">₹ {{ total_pending|floatformat:2 }}</div>
            <div class="analytics-subtitle">Pending Rate: {{ payment_analysis.pending_rate|floatformat:1 }}%</div>
        </div>
        
        <div class="analytics-card">
            <h3><i class="fas fa-file-invoice"></i> Total Invoices</h3>
            <div class="analytics-value">{{ invoice_analysis.total_invoices }}</div>
            <div class="analytics-subtitle">Avg Value: ₹{{ invoice_analysis.avg_invoice_value|floatformat:2 }}</div>
        </div>
        
        <div class="analytics-card">
            <h3><i class="fas fa-boxes"></i> Products Sold</h3>
            <div class="analytics-value">{{ realtime_stats.total_products_sold }}</div>
            <div class="analytics-subtitle">{{ realtime_stats.unique_products }} Unique Products</div>
        </div>
        
        <div class="analytics-card">
            <h3><i class="fas fa-users"></i> Customers Served</h3>
            <div class="analytics-value">{{ realtime_stats.unique_customers }}</div>
            <div class="analytics-subtitle">Avg Items/Invoice: {{ realtime_stats.avg_items_per_invoice|floatformat:1 }}</div>
        </div>
        
        <div class="analytics-card">
            <h3><i class="fas fa-percentage"></i> Total Discount</h3>
            <div class="analytics-value">₹ {{ realtime_stats.total_discount_given|floatformat:2 }}</div>
            <div class="analytics-subtitle">Discount Impact</div>
        </div>
        
        <div class="analytics-card">
            <h3><i class="fas fa-receipt"></i> Tax Collected</h3>
            <div class="analytics-value">₹ {{ realtime_stats.total_tax_collected|floatformat:2 }}</div>
            <div class="analytics-subtitle">GST/IGST Total</div>
        </div>
    </div>

    <!-- Enhanced Sales Invoices Table -->
    <div class="enhanced-table">
        <div class="table-header">
            <h3><i class="fas fa-file-invoice-dollar"></i> Sales Invoices ({{ sales_invoices.count }} invoices)</h3>
        </div>
        <div class="sales-invoices-body">
            <div class="sales-invoices-table-wrapper">
                <table id="salesTable" class="sales-invoices-table" width="100%" cellspacing="0">
                    <thead class="sales-invoices-thead">
                        <tr class="sales-invoices-header-row">
                            <th class="sales-invoice-no-header">Invoice No</th>
                            <th class="sales-date-header">Date</th>
                            <th class="sales-customer-header">Customer</th>
                            <th class="sales-customer-type-header">Type</th>
                            <th class="sales-total-header">Total Amount</th>
                            <th class="sales-paid-header">Paid Amount</th>
                            <th class="sales-balance-header">Balance</th>
                            <th class="sales-status-header">Status</th>
                            <th class="sales-action-header">Action</th>
                        </tr>
                    </thead>
                    <tbody class="sales-invoices-tbody">
                        {% for invoice in sales_invoices %}
                        <tr class="sales-invoice-row">
                            <td class="sales-invoice-no-cell">{{ invoice.sales_invoice_no }}</td>
                            <td class="sales-date-cell">{{ invoice.sales_invoice_date|date:"d-m-Y" }}</td>
                            <td class="sales-customer-cell">{{ invoice.customerid.customer_name }}</td>
                            <td class="sales-customer-type-cell">{{ invoice.customerid.customer_type }}</td>
                            <td class="sales-total-cell">₹ {{ invoice.sales_invoice_total|floatformat:2 }}</td>
                            <td class="sales-paid-cell">₹ {{ invoice.sales_invoice_paid|floatformat:2 }}</td>
                            <td class="sales-balance-cell">₹ {{ invoice.sales_invoice_total|sub:invoice.sales_invoice_paid|floatformat:2 }}</td>
                            <td class="sales-status-cell">
                                {% if invoice.sales_invoice_paid >= invoice.sales_invoice_total %}
                                <span class="badge badge-success">Fully Paid</span>
                                {% elif invoice.sales_invoice_paid > 0 %}
                                <span class="badge badge-warning">Partial</span>
                                {% else %}
                                <span class="badge badge-danger">Unpaid</span>
                                {% endif %}
                            </td>
                            <td class="sales-action-cell">
                                <a href="{% url 'sales_invoice_detail' pk=invoice.sales_invoice_no %}" class="btn btn-sm btn-primary">
                                    <i class="fas fa-eye"></i> View
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr class="sales-invoice-empty-row">
                            <td colspan="9" class="sales-invoice-no-data text-center">No sales invoices found for the selected period</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Enhanced Sales Analysis Section -->
    <div class="row">
        <!-- Product-wise Sales Analysis -->
        <div class="col-md-6">
            <div class="enhanced-table">
                <div class="table-header">
                    <h3><i class="fas fa-pills"></i> Product-wise Sales Analysis</h3>
                </div>
                <div class="sales-products-body">
                    <div class="sales-products-table-wrapper">
                        <table id="productSalesTable" class="sales-products-table" width="100%" cellspacing="0">
                            <thead class="sales-products-thead">
                                <tr class="sales-products-header-row">
                                    <th>Product Name</th>
                                    <th>Company</th>
                                    <th>Quantity</th>
                                    <th>Amount</th>
                                    <th>Avg Rate</th>
                                    <th>Invoices</th>
                                </tr>
                            </thead>
                            <tbody class="sales-products-tbody">
                                {% for item in product_sales %}
                                <tr class="sales-product-row">
                                    <td class="sales-product-name-cell">{{ item.productid__product_name|truncatechars:30 }}</td>
                                    <td class="sales-product-company-cell">{{ item.productid__product_company|truncatechars:20 }}</td>
                                    <td class="sales-product-quantity-cell">{{ item.total_quantity|floatformat:0 }}</td>
                                    <td class="sales-product-amount-cell">₹ {{ item.total_amount|floatformat:2 }}</td>
                                    <td class="sales-product-rate-cell">₹ {{ item.avg_rate|floatformat:2 }}</td>
                                    <td class="sales-product-invoices-cell">{{ item.invoice_count }}</td>
                                </tr>
                                {% empty %}
                                <tr class="sales-product-empty-row">
                                    <td colspan="6" class="sales-product-no-data text-center">No product sales data available</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Customer-wise Sales Analysis -->
        <div class="col-md-6">
            <div class="enhanced-table">
                <div class="table-header">
                    <h3><i class="fas fa-users"></i> Customer-wise Sales Analysis</h3>
                </div>
                <div class="sales-customers-body">
                    <div class="sales-customers-table-wrapper">
                        <table id="customerSalesTable" class="sales-customers-table" width="100%" cellspacing="0">
                            <thead class="sales-customers-thead">
                                <tr class="sales-customers-header-row">
                                    <th>Customer Name</th>
                                    <th>Type</th>
                                    <th>Total Amount</th>
                                    <th>Invoices</th>
                                    <th>Avg Invoice</th>
                                    <th>Last Purchase</th>
                                </tr>
                            </thead>
                            <tbody class="sales-customers-tbody">
                                {% for item in customer_sales %}
                                <tr class="sales-customer-row">
                                    <td class="sales-customer-name-cell">{{ item.sales_invoice_no__customerid__customer_name|truncatechars:25 }}</td>
                                    <td class="sales-customer-type-cell">{{ item.sales_invoice_no__customerid__customer_type }}</td>
                                    <td class="sales-customer-amount-cell">₹ {{ item.total_amount|floatformat:2 }}</td>
                                    <td class="sales-customer-invoices-cell">{{ item.invoice_count }}</td>
                                    <td class="sales-customer-avg-cell">₹ {{ item.avg_invoice_value|floatformat:2 }}</td>
                                    <td class="sales-customer-last-cell">{{ item.last_purchase_date|date:"d-m-Y" }}</td>
                                </tr>
                                {% empty %}
                                <tr class="sales-customer-empty-row">
                                    <td colspan="6" class="sales-customer-no-data text-center">No customer sales data available</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Charts and Analytics -->
    <div class="row">
        <!-- Product Distribution Chart -->
        <div class="col-md-6">
            <div class="chart-container">
                <h3><i class="fas fa-chart-pie"></i> Product Sales Distribution</h3>
                <canvas id="productChart" height="300"></canvas>
            </div>
        </div>

        <!-- Customer Distribution Chart -->
        <div class="col-md-6">
            <div class="chart-container">
                <h3><i class="fas fa-chart-doughnut"></i> Customer Sales Distribution</h3>
                <canvas id="customerChart" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Sales Trend Charts -->
    <div class="row">
        <!-- Daily Sales Trend -->
        <div class="col-md-6">
            <div class="chart-container">
                <h3><i class="fas fa-chart-line"></i> Daily Sales Trend</h3>
                <canvas id="dailyTrendChart" height="300"></canvas>
            </div>
        </div>
        
        <!-- Monthly Sales Comparison -->
        <div class="col-md-6">
            <div class="chart-container">
                <h3><i class="fas fa-chart-bar"></i> Monthly Sales Comparison (Last 12 Months)</h3>
                <canvas id="monthlyTrendChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Real-time Status Indicator -->
<div class="fixed-bottom" style="right: 20px; bottom: 20px; left: auto; width: auto;">
    <div class="alert alert-info alert-dismissible fade show" role="alert" style="margin: 0;">
        <span class="realtime-indicator"></span>
        <strong>Live Data:</strong> Report updates with real-time calculations
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
    $(document).ready(function() {
        // Initialize Enhanced DataTables
        $('#salesTable').DataTable({
            "order": [[1, "desc"]],
            "pageLength": 25,
            "responsive": true
        });
        
        $('#productSalesTable').DataTable({
            "order": [[3, "desc"]],
            "pageLength": 15,
            "responsive": true
        });
        
        $('#customerSalesTable').DataTable({
            "order": [[2, "desc"]],
            "pageLength": 15,
            "responsive": true
        });

        // Enhanced color palette
        function generateColors(num) {
            var colors = [
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 99, 132, 0.8)',
                'rgba(255, 205, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 159, 64, 0.8)',
                'rgba(199, 199, 199, 0.8)',
                'rgba(83, 102, 255, 0.8)',
                'rgba(255, 99, 255, 0.8)',
                'rgba(99, 255, 132, 0.8)'
            ];
            
            while (colors.length < num) {
                var r = Math.floor(Math.random() * 200);
                var g = Math.floor(Math.random() * 200);
                var b = Math.floor(Math.random() * 200);
                colors.push('rgba(' + r + ', ' + g + ', ' + b + ', 0.8)');
            }
            return colors.slice(0, num);
        }

        // Product Sales Chart (Enhanced)
        var productCtx = document.getElementById('productChart').getContext('2d');
        var productData = {
            labels: [{% for item in product_sales|slice:":10" %}'{{ item.productid__product_name|truncatechars:20 }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                label: 'Sales Amount (₹)',
                data: [{% for item in product_sales|slice:":10" %}{{ item.total_amount }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                backgroundColor: generateColors({{ product_sales|slice:":10"|length }}),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        };
        var productChart = new Chart(productCtx, {
            type: 'doughnut',
            data: productData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ₹' + context.parsed.toLocaleString();
                            }
                        }
                    }
                }
            }
        });

        // Customer Sales Chart (Enhanced)
        var customerCtx = document.getElementById('customerChart').getContext('2d');
        var customerData = {
            labels: [{% for item in customer_sales|slice:":10" %}'{{ item.sales_invoice_no__customerid__customer_name|truncatechars:20 }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                label: 'Sales Amount (₹)',
                data: [{% for item in customer_sales|slice:":10" %}{{ item.total_amount }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                backgroundColor: generateColors({{ customer_sales|slice:":10"|length }}),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        };
        var customerChart = new Chart(customerCtx, {
            type: 'pie',
            data: customerData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ₹' + context.parsed.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
        
        // Daily Sales Trend Chart
        var dailyCtx = document.getElementById('dailyTrendChart').getContext('2d');
        var dailyChart = new Chart(dailyCtx, {
            type: 'line',
            data: {
                labels: [{% for item in daily_sales %}'{{ item.day|date:"M d" }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
                datasets: [{
                    label: 'Daily Sales (₹)',
                    data: [{% for item in daily_sales %}{{ item.daily_total }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₹' + value.toLocaleString();
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Sales: ₹' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
        
        // Monthly Sales Trend Chart
        var monthlyCtx = document.getElementById('monthlyTrendChart').getContext('2d');
        var monthlyChart = new Chart(monthlyCtx, {
            type: 'bar',
            data: {
                labels: [{% for item in monthly_sales %}'{{ item.month }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
                datasets: [{
                    label: 'Monthly Sales (₹)',
                    data: [{% for item in monthly_sales %}{{ item.total }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                    backgroundColor: 'rgba(75, 192, 192, 0.8)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₹' + value.toLocaleString();
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Sales: ₹' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    });
    
    // Real-time data refresh function
    function refreshData() {
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        
        if (startDate && endDate) {
            window.location.href = `?start_date=${startDate}&end_date=${endDate}`;
        } else {
            window.location.reload();
        }
    }
    
    // Quick range functions
    function setQuickRange(period) {
        const today = new Date();
        const startInput = document.getElementById('start_date');
        const endInput = document.getElementById('end_date');
        
        switch(period) {
            case 'today':
                startInput.value = today.toISOString().split('T')[0];
                endInput.value = today.toISOString().split('T')[0];
                break;
            case 'week':
                const weekStart = new Date(today.setDate(today.getDate() - today.getDay()));
                startInput.value = weekStart.toISOString().split('T')[0];
                endInput.value = new Date().toISOString().split('T')[0];
                break;
            case 'month':
                const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                startInput.value = monthStart.toISOString().split('T')[0];
                endInput.value = new Date().toISOString().split('T')[0];
                break;
        }
    }
    
    function exportReport(format) {
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        const url = format === 'pdf' ? 
            `{% url 'export_sales_pdf' %}?start_date=${startDate}&end_date=${endDate}` :
            `{% url 'export_sales_excel' %}?start_date=${startDate}&end_date=${endDate}`;
        window.open(url, '_blank');
    }
    
    // Auto-refresh indicator
    setInterval(function() {
        const indicator = document.querySelector('.realtime-indicator');
        if (indicator) {
            indicator.style.animation = 'none';
            setTimeout(() => {
                indicator.style.animation = 'pulse 2s infinite';
            }, 100);
        }
    }, 300000); // 5 minutes
</script>
{% endblock %}







