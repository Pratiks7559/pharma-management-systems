{% extends 'base.html' %}
{% load static %}

{% block title %}Low Stock Update{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/low_stock_update.css' %}">
{% endblock %}

{% block content %}
<div class="low-stock-container">
    <div class="low-stock-header">
        <h1 class="low-stock-title">Low Stock Update</h1>
        <div>
            <span>{{ low_stock_items|length }} items need restocking</span>
        </div>
    </div>

    <div id="messages">
        {% if messages %}
            {% for message in messages %}
                <div class="{% if message.tags == 'success' %}success-message{% else %}error-message{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Loading low stock items...</p>
    </div>

    {% if low_stock_items %}
    <div class="stock-update-form">
        <div class="bulk-actions">
            <button type="button" class="btn-bulk btn-bulk-update" onclick="bulkUpdate()">
                <i class="fas fa-check-circle"></i> Update All
            </button>
            <button type="button" class="btn-bulk btn-bulk-clear" onclick="clearAll()">
                <i class="fas fa-eraser"></i> Clear All
            </button>
        </div>

        <div class="form-header">
            <div>Product</div>
            <div>Supplier</div>
            <div>Current Stock</div>
            <div>Batch No</div>
            <div>Expiry (MM-YYYY)</div>
            <div>MRP</div>
            <div>Purchase Rate</div>
            <div>Add Quantity</div>
            <div>Discount (%)</div>
            <div>GST (%)</div>
            <div>Action</div>
        </div>

        <form id="stockUpdateForm">
            {% csrf_token %}
            {% for item in low_stock_items %}
            <div class="form-row" data-product-id="{{ item.product.productid }}" data-batch-no="{{ item.batch_no }}">
                <div class="product-info">
                    <div class="product-name">{{ item.product.product_name }}</div>
                    <div class="product-details">{{ item.product.product_company }} | {{ item.product.product_packing }}</div>
                    {% if item.batch_no %}
                        <div class="batch-info">
                            <strong>Existing Batch:</strong> {{ item.batch_no }} (Exp: {{ item.expiry }})
                        </div>
                    {% endif %}
                </div>
                <select name="supplier_{{ item.product.productid }}_{{ forloop.counter }}" required class="supplier-select">
                    <option value="">Select Supplier</option>
                    {% for supplier in suppliers %}
                        <option value="{{ supplier.supplierid }}">{{ supplier.supplier_name|truncatechars:20 }}</option>
                    {% endfor %}
                </select>
                <div class="current-stock">{{ item.current_stock|floatformat:0 }}</div>
                <div class="batch-input-container">
                    <input type="text" name="batch_no_{{ item.product.productid }}_{{ forloop.counter }}" 
                           placeholder="Batch No" value="{{ item.batch_no }}" required 
                           class="batch-input" data-product-id="{{ item.product.productid }}">
                    <div class="batch-suggestions" id="suggestions_{{ item.product.productid }}_{{ forloop.counter }}">
                    </div>
                </div>
                <input type="text" name="expiry_{{ item.product.productid }}_{{ forloop.counter }}" 
                       placeholder="MM-YYYY" pattern="[0-9]{2}-[0-9]{4}" value="{{ item.expiry }}" required 
                       class="expiry-input">
                <input type="number" name="mrp_{{ item.product.productid }}_{{ forloop.counter }}" 
                       step="0.01" placeholder="MRP" value="{{ item.mrp|floatformat:2 }}" required class="mrp-input">
                <input type="number" name="purchase_rate_{{ item.product.productid }}_{{ forloop.counter }}" 
                       step="0.01" placeholder="Rate" required class="purchase-rate-input" 
                       data-product-id="{{ item.product.productid }}" data-counter="{{ forloop.counter }}">
                <input type="number" name="quantity_{{ item.product.productid }}_{{ forloop.counter }}" 
                       step="1" min="1" placeholder="Qty" required>
                <input type="number" name="discount_{{ item.product.productid }}_{{ forloop.counter }}" 
                       step="0.01" min="0" max="100" placeholder="0" value="0">
                <input type="number" name="gst_{{ item.product.productid }}_{{ forloop.counter }}" 
                       step="0.01" min="0" max="100" placeholder="0" value="0">
                <button type="button" class="btn-update" onclick="updateSingleItem({{ item.product.productid }}, {{ forloop.counter }})">
                    Update
                </button>
            </div>
            {% endfor %}
        </form>
    </div>
    {% else %}
    <div class="no-items">
        <i class="fas fa-check-circle" style="font-size: 48px; color: #4caf50; margin-bottom: 20px;"></i>
        <p>All products are well stocked!</p>
        <a href="{% url 'inventory_list' %}" class="btn btn-primary">View Inventory</a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
function showLoading() {
    document.getElementById('loading').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loading').style.display = 'none';
}

// Show loading on page load
window.addEventListener('beforeunload', function() {
    showLoading();
});

// Hide loading when page is fully loaded
window.addEventListener('load', function() {
    hideLoading();
});

// Alt+U keyboard shortcut
document.addEventListener('keydown', function(e) {
    if (e.altKey && e.key.toLowerCase() === 'u') {
        e.preventDefault();
        // Focus on first supplier dropdown or batch input
        const firstInput = document.querySelector('.supplier-select, .batch-input');
        if (firstInput) {
            firstInput.focus();
        }
    }
});

function updateSingleItem(productId, counter) {
    // Prevent double submission
    const button = event.target;
    if (button.disabled) return;
    button.disabled = true;
    
    const form = document.getElementById('stockUpdateForm');
    const formData = new FormData(form);
    
    // Get values for this specific product and counter
    const supplierId = formData.get(`supplier_${productId}_${counter}`);
    const batchNo = formData.get(`batch_no_${productId}_${counter}`);
    const expiry = formData.get(`expiry_${productId}_${counter}`);
    const purchaseRate = formData.get(`purchase_rate_${productId}_${counter}`);
    const mrp = formData.get(`mrp_${productId}_${counter}`);
    const discount = formData.get(`discount_${productId}_${counter}`) || 0;
    const gst = formData.get(`gst_${productId}_${counter}`) || 0;
    const quantity = formData.get(`quantity_${productId}_${counter}`);
    
    if (!supplierId || !batchNo || !expiry || !purchaseRate || !mrp || !quantity) {
        alert('Please fill all fields including supplier and MRP for this product');
        button.disabled = false;
        return;
    }
    
    // Validate expiry format
    if (!/^\d{2}-\d{4}$/.test(expiry)) {
        alert('Please enter expiry in MM-YYYY format');
        return;
    }
    
    showLoading();
    
    const updateData = {
        product_id: productId,
        supplier_id: parseInt(supplierId),
        batch_no: batchNo,
        expiry: expiry,
        purchase_rate: parseFloat(purchaseRate),
        mrp: parseFloat(mrp),
        discount: parseFloat(discount),
        gst: parseFloat(gst),
        quantity: parseInt(quantity),
        csrfmiddlewaretoken: formData.get('csrfmiddlewaretoken')
    };
    
    fetch('{% url "update_low_stock_item" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        },
        body: JSON.stringify(updateData)
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            // Show success message
            showMessage(data.message, 'success');
            // Remove the row or update it
            const row = document.querySelector(`[data-product-id="${productId}"][data-batch-no="${batchNo}"]`);
            if (row) {
                row.style.background = '#d4edda';
                row.querySelector('.btn-update').textContent = 'Updated';
                row.querySelector('.btn-update').disabled = true;
                
                // Update current stock display
                const currentStockEl = row.querySelector('.current-stock');
                const newStock = parseInt(currentStockEl.textContent) + parseInt(quantity);
                currentStockEl.textContent = newStock;
                currentStockEl.style.color = newStock > 10 ? '#4caf50' : '#ff9800';
            }
        } else {
            showMessage(data.error || 'Failed to update stock', 'error');
        }
        button.disabled = false;
    })
    .catch(error => {
        hideLoading();
        showMessage('Network error occurred', 'error');
        console.error('Error:', error);
        button.disabled = false;
    });
}

function bulkUpdate() {
    const form = document.getElementById('stockUpdateForm');
    const formData = new FormData(form);
    const updates = [];
    
    // Collect all product updates
    {% for item in low_stock_items %}
    const supplierId{{ item.product.productid }}_{{ forloop.counter }} = formData.get('supplier_{{ item.product.productid }}_{{ forloop.counter }}');
    const batchNo{{ item.product.productid }}_{{ forloop.counter }} = formData.get('batch_no_{{ item.product.productid }}_{{ forloop.counter }}');
    const expiry{{ item.product.productid }}_{{ forloop.counter }} = formData.get('expiry_{{ item.product.productid }}_{{ forloop.counter }}');
    const purchaseRate{{ item.product.productid }}_{{ forloop.counter }} = formData.get('purchase_rate_{{ item.product.productid }}_{{ forloop.counter }}');
    const mrp{{ item.product.productid }}_{{ forloop.counter }} = formData.get('mrp_{{ item.product.productid }}_{{ forloop.counter }}');
    const discount{{ item.product.productid }}_{{ forloop.counter }} = formData.get('discount_{{ item.product.productid }}_{{ forloop.counter }}') || 0;
    const gst{{ item.product.productid }}_{{ forloop.counter }} = formData.get('gst_{{ item.product.productid }}_{{ forloop.counter }}') || 0;
    const quantity{{ item.product.productid }}_{{ forloop.counter }} = formData.get('quantity_{{ item.product.productid }}_{{ forloop.counter }}');
    
    if (supplierId{{ item.product.productid }}_{{ forloop.counter }} && batchNo{{ item.product.productid }}_{{ forloop.counter }} && expiry{{ item.product.productid }}_{{ forloop.counter }} && purchaseRate{{ item.product.productid }}_{{ forloop.counter }} && mrp{{ item.product.productid }}_{{ forloop.counter }} && quantity{{ item.product.productid }}_{{ forloop.counter }}) {
        if (!/^\d{2}-\d{4}$/.test(expiry{{ item.product.productid }}_{{ forloop.counter }})) {
            alert('Please enter expiry in MM-YYYY format for {{ item.product.product_name }}');
            return;
        }
        
        updates.push({
            product_id: {{ item.product.productid }},
            supplier_id: parseInt(supplierId{{ item.product.productid }}_{{ forloop.counter }}),
            batch_no: batchNo{{ item.product.productid }}_{{ forloop.counter }},
            expiry: expiry{{ item.product.productid }}_{{ forloop.counter }},
            purchase_rate: parseFloat(purchaseRate{{ item.product.productid }}_{{ forloop.counter }}),
            mrp: parseFloat(mrp{{ item.product.productid }}_{{ forloop.counter }}),
            discount: parseFloat(discount{{ item.product.productid }}_{{ forloop.counter }}),
            gst: parseFloat(gst{{ item.product.productid }}_{{ forloop.counter }}),
            quantity: parseInt(quantity{{ item.product.productid }}_{{ forloop.counter }})
        });
    }
    {% endfor %}
    
    if (updates.length === 0) {
        alert('Please fill at least one product details');
        return;
    }
    
    showLoading();
    
    fetch('{% url "bulk_update_low_stock" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        },
        body: JSON.stringify({updates: updates})
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showMessage(`Successfully updated ${data.updated_count} products`, 'success');
            // Refresh page after 2 seconds
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            showMessage(data.error || 'Failed to update stock', 'error');
        }
    })
    .catch(error => {
        hideLoading();
        showMessage('Network error occurred', 'error');
        console.error('Error:', error);
    });
}

function clearAll() {
    if (confirm('Are you sure you want to clear all fields?')) {
        const form = document.getElementById('stockUpdateForm');
        form.reset();
    }
}

function showMessage(message, type) {
    const messagesDiv = document.getElementById('messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
    messageDiv.textContent = message;
    messagesDiv.appendChild(messageDiv);
    
    // Remove message after 5 seconds
    setTimeout(() => {
        messageDiv.remove();
    }, 5000);
}

// Batch autofill and MRP calculation functionality
document.addEventListener('DOMContentLoaded', function() {
    const batchInputs = document.querySelectorAll('.batch-input');
    const purchaseRateInputs = document.querySelectorAll('.purchase-rate-input');
    
    batchInputs.forEach(input => {
        const productId = input.getAttribute('data-product-id');
        const suggestionsDiv = input.parentElement.querySelector('.batch-suggestions');
        
        input.addEventListener('focus', function() {
            loadBatchSuggestions(productId, suggestionsDiv, input);
        });
        
        input.addEventListener('input', function() {
            filterBatchSuggestions(suggestionsDiv, input.value);
        });
        
        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!input.parentElement.contains(e.target)) {
                suggestionsDiv.style.display = 'none';
            }
        });
    });
    
    // MRP is now pre-filled from database, no calculation needed
});

function loadBatchSuggestions(productId, suggestionsDiv, inputElement) {
    fetch(`/get-batch-suggestions/?product_id=${productId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success && data.batches.length > 0) {
            suggestionsDiv.innerHTML = '';
            data.batches.forEach(batch => {
                const suggestionItem = document.createElement('div');
                suggestionItem.style.cssText = 'padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 12px;';
                suggestionItem.innerHTML = `<strong>${batch.batch_no}</strong><br><small style="color: #666;">Exp: ${batch.expiry}</small>`;
                
                suggestionItem.addEventListener('mouseenter', function() {
                    this.style.background = '#f0f0f0';
                });
                
                suggestionItem.addEventListener('mouseleave', function() {
                    this.style.background = 'white';
                });
                
                suggestionItem.addEventListener('click', function() {
                    inputElement.value = batch.batch_no;
                    // Also fill expiry field
                    const expiryInput = inputElement.closest('.form-row').querySelector('.expiry-input');
                    if (expiryInput) {
                        expiryInput.value = batch.expiry;
                    }
                    suggestionsDiv.style.display = 'none';
                });
                
                suggestionsDiv.appendChild(suggestionItem);
            });
            suggestionsDiv.style.display = 'block';
        } else {
            suggestionsDiv.style.display = 'none';
        }
    })
    .catch(error => {
        console.error('Error loading batch suggestions:', error);
        suggestionsDiv.style.display = 'none';
    });
}

function filterBatchSuggestions(suggestionsDiv, searchValue) {
    const suggestions = suggestionsDiv.querySelectorAll('div');
    let hasVisible = false;
    
    suggestions.forEach(suggestion => {
        const batchNo = suggestion.querySelector('strong').textContent;
        if (batchNo.toLowerCase().includes(searchValue.toLowerCase())) {
            suggestion.style.display = 'block';
            hasVisible = true;
        } else {
            suggestion.style.display = 'none';
        }
    });
    
    suggestionsDiv.style.display = hasVisible ? 'block' : 'none';
}
</script>
{% endblock %}