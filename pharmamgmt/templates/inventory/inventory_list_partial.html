{% load custom_filters %}
{% for item in inventory_data %}
<tr class="inventory-row" data-product-id="{{ item.product.productid }}">
    <td class="td-product-name">
        <a href="{% url 'product_detail' item.product.productid %}" class="product-link">
            {{ item.product.product_name|truncatechars:40 }}
        </a>
    </td>
    <td class="td-company">{{ item.product.product_company|truncatechars:20 }}</td>
    <td class="td-packing">{{ item.product.product_packing }}</td>
    <td class="td-category">{{ item.product.product_category|default:"N/A" }}</td>
    <td class="td-batch">
        {% if item.batches_info %}
            <div class="batches-container" style="max-height: 120px; overflow-y: auto; min-width: 150px;">
                {% for batch in item.batches_info %}
                    <div class="batch-item" style="margin-bottom: 5px; padding: 3px 6px; background: #f8f9fa; border-radius: 3px; font-size: 12px; border-left: 3px solid #007bff;">
                        <strong>{{ batch.batch_no }}</strong>
                        <span class="{% if batch.stock <= 0 %}text-danger{% elif batch.stock <= 10 %}text-warning{% else %}text-success{% endif %}" style="margin-left: 8px;">
                            ({{ batch.stock|floatformat:0 }})
                        </span>
                        {% if batch.expiry %}
                            <br><small class="text-muted">Exp: {{ batch.expiry|expiry_mmyyyy }}</small>
                        {% endif %}
                        <br><small class="text-info">MRP: ₹{{ batch.mrp|floatformat:2 }}</small>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <span class="text-muted">No Batches</span>
        {% endif %}
    </td>
    <td class="td-expiry">
        {% if item.batches_info %}
            <div class="expiry-container" style="max-height: 120px; overflow-y: auto;">
                {% for batch in item.batches_info %}
                    <div style="margin-bottom: 3px; font-size: 12px;">
                        {% if batch.expiry %}
                            {{ batch.expiry|expiry_mmyyyy }}
                        {% else %}
                            <span class="text-muted">N/A</span>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <span class="text-muted">N/A</span>
        {% endif %}
    </td>
    <td class="td-mrp">₹{{ item.avg_mrp|floatformat:2 }}</td>
    <td class="td-rates">
        {% if item.batches_info %}
            <div class="rates-container" style="max-height: 120px; overflow-y: auto;">
                {% for batch in item.batches_info %}
                    <div style="margin-bottom: 3px; font-size: 12px; padding: 2px 4px; background: #f8f9fa; border-radius: 3px;">
                        <strong>{{ batch.batch_no }}</strong><br>
                        {% if batch.rates.rate_A > 0 or batch.rates.rate_B > 0 or batch.rates.rate_C > 0 %}
                            <small class="text-primary">
                                {% if batch.rates.rate_A > 0 %}A: ₹{{ batch.rates.rate_A|floatformat:0 }}<br>{% endif %}
                                {% if batch.rates.rate_B > 0 %}B: ₹{{ batch.rates.rate_B|floatformat:0 }}<br>{% endif %}
                                {% if batch.rates.rate_C > 0 %}C: ₹{{ batch.rates.rate_C|floatformat:0 }}{% endif %}
                            </small>
                        {% else %}
                            <small class="text-muted">No rates</small>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <span class="text-muted">No batches</span>
        {% endif %}
    </td>
    <td class="td-value">₹{{ item.stock_value|floatformat:2 }}</td>
    <td class="td-status">
        {% if item.current_stock <= 0 %}
        <span class="status-badge out-of-stock">{{ item.status }}</span>
        {% elif item.current_stock < 10 %}
        <span class="status-badge low-stock">{{ item.status }}</span>
        {% else %}
        <span class="status-badge in-stock">{{ item.status }}</span>
        {% endif %}
    </td>
    <td class="td-actions no-print">
        <div class="action-buttons" role="group">
            <a href="{% url 'product_detail' item.product.productid %}" class="action-btn view-btn" title="View Details">
                <i class="fas fa-eye"></i>
            </a>
            <a href="{% url 'update_product' item.product.productid %}" class="action-btn edit-btn" title="Edit Product">
                <i class="fas fa-edit"></i>
            </a>
        </div>
    </td>
</tr>
{% endfor %}